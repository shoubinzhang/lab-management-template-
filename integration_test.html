<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实验室管理应用集成测试</title>
    <script src="config.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        h2 {
            color: #3498db;
            margin-top: 0;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>实验室管理应用集成测试</h1>
    
    <div class="test-section">
        <h2>测试1: 前端服务器</h2>
        <p>检查前端服务器是否正常运行</p>
        <button onclick="testFrontendServer()">运行测试</button>
        <div id="frontendResult" class="result">准备测试...</div>
    </div>
    
    <div class="test-section">
        <h2>测试2: 后端API</h2>
        <p>检查后端API是否正常运行</p>
        <button onclick="testBackendApi()">运行测试</button>
        <div id="backendResult" class="result">准备测试...</div>
    </div>
    
    <div class="test-section">
        <h2>测试3: 前端代理</h2>
        <p>检查前端代理是否能正确转发请求到后端</p>
        <button onclick="testFrontendProxy()">运行测试</button>
        <div id="proxyResult" class="result">准备测试...</div>
    </div>
    
    <div class="test-section">
        <h2>测试4: WebSocket连接</h2>
        <p>检查WebSocket连接是否正常</p>
        <button onclick="testWebSocket()">运行测试</button>
        <div id="websocketResult" class="result">准备测试...</div>
        <button onclick="closeWebSocket()" disabled>关闭连接</button>
    </div>

    <script>
        // 配置加载状态管理
        let configLoaded = false;
        let configLoadTimeout = null;
        let ws = null;
        let configSource = '默认配置';
        
        // 等待AppConfig加载完成
        function waitForAppConfig(callback) {
            if (window.AppConfig && (window.AppConfig.apiUrl || window.AppConfig.frontendUrl)) {
                configLoaded = true;
                configSource = 'config.js';
                callback();
            } else {
                // 设置默认配置，以防config.js加载失败
                if (!window.AppConfig) {
                    const currentHost = window.location.hostname === 'localhost' || window.location.hostname === '' ? 'localhost' : window.location.hostname;
                    window.AppConfig = {
                        apiUrl: currentHost,
                        apiPort: '8000',
                        frontendPort: '3000'
                    };
                }
                
                // 尝试等待配置加载
                setTimeout(() => waitForAppConfig(callback), 100);
                
                // 设置超时处理
                if (!configLoadTimeout) {
                    configLoadTimeout = setTimeout(() => {
                        console.warn('配置加载超时，使用默认配置');
                        configLoaded = true;
                        configSource = '默认配置';
                        callback();
                    }, 3000);
                }
            }
        }
        
        // 获取API基础URL
        function getApiBaseUrl() {
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            
            // 优先使用完整的frontendUrl配置
            if (window.AppConfig && window.AppConfig.apiUrl && window.AppConfig.apiUrl.includes('://')) {
                return window.AppConfig.apiUrl;
            }
            
            // 其次使用单独配置的apiUrl和apiPort
            if (window.AppConfig) {
                const host = window.AppConfig.apiUrl || window.location.hostname === '' ? 'localhost' : window.location.hostname;
                const port = window.AppConfig.apiPort || '8000';
                return `${protocol}//${host}:${port}`;
            }
            
            // 最后使用当前页面的协议和主机名作为默认值
            const currentHost = window.location.hostname === '' ? 'localhost' : window.location.hostname;
            return `${protocol}//${currentHost}:8000`;
        }
        
        // 获取前端基础URL
        function getFrontendBaseUrl() {
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            
            // 优先使用完整的frontendUrl配置
            if (window.AppConfig && window.AppConfig.frontendUrl && window.AppConfig.frontendUrl.includes('://')) {
                return window.AppConfig.frontendUrl;
            }
            
            // 其次使用单独配置的apiUrl和frontendPort
            if (window.AppConfig) {
                const host = window.AppConfig.apiUrl || window.location.hostname === '' ? 'localhost' : window.location.hostname;
                const port = window.AppConfig.frontendPort || '3000';
                return `${protocol}//${host}:${port}`;
            }
            
            // 最后使用当前页面的协议和主机名作为默认值
            const currentHost = window.location.hostname === '' ? 'localhost' : window.location.hostname;
            return `${protocol}//${currentHost}:3000`;
        }
        
        // 获取WebSocket基础URL
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            
            // 优先使用完整的apiUrl配置并转换为WebSocket协议
            if (window.AppConfig && window.AppConfig.apiUrl && window.AppConfig.apiUrl.includes('://')) {
                return window.AppConfig.apiUrl.replace(/^http(s)?:/, 'ws$1:');
            }
            
            // 其次使用单独配置的apiUrl和apiPort
            if (window.AppConfig) {
                const host = window.AppConfig.apiUrl || window.location.hostname === '' ? 'localhost' : window.location.hostname;
                const port = window.AppConfig.apiPort || '8000';
                return `${protocol}//${host}:${port}`;
            }
            
            // 最后使用当前页面的协议和主机名作为默认值
            const currentHost = window.location.hostname === '' ? 'localhost' : window.location.hostname;
            return `${protocol}//${currentHost}:8000`;
        }
        
        // 动态加载config.js
        function loadConfigJs() {
            return new Promise((resolve, reject) => {
                // 检查config.js是否已经加载
                if (document.querySelector('script[src="config.js"]')) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'config.js';
                script.onload = () => resolve();
                script.onerror = () => {
                    console.warn('config.js加载失败，将使用默认配置');
                    reject(new Error('config.js加载失败'));
                };
                document.head.appendChild(script);
            });
        }
        
        // 页面加载完成后等待配置就绪
        window.onload = function() {
            // 尝试动态加载config.js
            loadConfigJs().catch(() => {
                // config.js加载失败，创建默认配置
                if (!window.AppConfig) {
                    const currentHost = window.location.hostname === 'localhost' || window.location.hostname === '' ? 'localhost' : window.location.hostname;
                    window.AppConfig = {
                        apiUrl: currentHost,
                        apiPort: '8000',
                        frontendPort: '3000'
                    };
                }
            }).finally(() => {
                // 无论config.js是否加载成功，都等待配置
                waitForAppConfig(() => {
                    console.log('配置加载完成，当前API地址:', getApiBaseUrl());
                    console.log('当前前端地址:', getFrontendBaseUrl());
                    console.log('配置来源:', configSource);
                    
                    // 添加一个简单的配置信息显示
                    showConfigInfo();
                });
            });
        };
        
        // 显示配置信息
        function showConfigInfo() {
            // 创建一个配置信息区域
            const configSection = document.createElement('div');
            configSection.className = 'test-section';
            configSection.innerHTML = `
                <h2>配置信息</h2>
                <div class="result">
                    <p><strong>配置来源:</strong> ${configSource}</p>
                    <p><strong>API基础URL:</strong> ${getApiBaseUrl()}</p>
                    <p><strong>前端基础URL:</strong> ${getFrontendBaseUrl()}</p>
                    <p><strong>WebSocket基础URL:</strong> ${getWebSocketUrl()}</p>
                </div>
            `;
            
            // 将配置信息区域添加到页面顶部
            const firstSection = document.querySelector('.test-section');
            document.body.insertBefore(configSection, firstSection);
        };
        
        // 测试前端服务器
        async function testFrontendServer() {
            const resultElem = document.getElementById('frontendResult');
            resultElem.className = 'result loading';
            resultElem.textContent = '测试中...';
            
            try {
                const frontendUrl = getFrontendBaseUrl();
                const response = await fetch(frontendUrl, { timeout: 5000 });
                resultElem.className = 'result success';
                resultElem.innerHTML = `✅ 前端服务器正常<br>地址: ${frontendUrl}<br>状态码: ${response.status} ${response.statusText}`;
            } catch (error) {
                resultElem.className = 'result error';
                resultElem.textContent = `❌ 前端服务器访问失败: ${error.message}`;
            }
        }
        
        // 测试后端API
        async function testBackendApi() {
            const resultElem = document.getElementById('backendResult');
            resultElem.className = 'result loading';
            resultElem.textContent = '测试中...';
            
            try {
                const apiBaseUrl = getApiBaseUrl();
                const response = await fetch(`${apiBaseUrl}/docs`, { timeout: 5000 });
                resultElem.className = 'result success';
                resultElem.innerHTML = `✅ 后端API正常<br>地址: ${apiBaseUrl}/docs<br>状态码: ${response.status} ${response.statusText}`;
            } catch (error) {
                resultElem.className = 'result error';
                resultElem.textContent = `❌ 后端API访问失败: ${error.message}`;
            }
        }
        
        // 测试前端代理
        async function testFrontendProxy() {
            const resultElem = document.getElementById('proxyResult');
            resultElem.className = 'result loading';
            resultElem.textContent = '测试中...';
            
            try {
                const frontendUrl = getFrontendBaseUrl();
                const response = await fetch(`${frontendUrl}/api/health`, { timeout: 5000 });
                const data = await response.json();
                resultElem.className = 'result success';
                resultElem.innerHTML = `✅ 前端代理正常<br>地址: ${frontendUrl}/api/health<br>状态码: ${response.status} ${response.statusText}<br>后端健康状态: ${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultElem.className = 'result error';
                if (error.response) {
                    resultElem.innerHTML = `❌ 前端代理访问失败<br>状态码: ${error.response.status}<br>${error.message}`;
                } else {
                    resultElem.textContent = `❌ 前端代理访问失败: ${error.message}`;
                }
            }
        }
        
        // 测试WebSocket
        function testWebSocket() {
            const resultElem = document.getElementById('websocketResult');
            const closeBtn = document.querySelector('button[onclick="closeWebSocket()"]');
            
            resultElem.className = 'result loading';
            resultElem.textContent = '连接中...';
            
            try {
                const wsBaseUrl = getWebSocketUrl();
                ws = new WebSocket(`${wsBaseUrl}/api/ws/notifications`);
                resultElem.innerHTML += `<br>连接地址: ${wsBaseUrl}/api/ws/notifications`;
                
                ws.onopen = () => {
                    resultElem.className = 'result success';
                    resultElem.textContent = '✅ WebSocket连接成功建立';
                    closeBtn.disabled = false;
                };
                
                ws.onmessage = (event) => {
                    resultElem.innerHTML += `<br>收到消息: ${event.data}`;
                };
                
                ws.onerror = (error) => {
                    resultElem.className = 'result error';
                    resultElem.textContent = `❌ WebSocket连接失败: ${error.message || '未知错误'}`;
                };
                
                ws.onclose = () => {
                    resultElem.textContent += '\nWebSocket连接已关闭';
                    closeBtn.disabled = true;
                };
                
                // 设置超时
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.CONNECTING) {
                        resultElem.className = 'result error';
                        resultElem.textContent = '❌ WebSocket连接超时';
                        ws.close();
                    }
                }, 5000);
            } catch (error) {
                resultElem.className = 'result error';
                resultElem.textContent = `❌ WebSocket测试异常: ${error.message}`;
            }
        }
        
        // 关闭WebSocket连接
        function closeWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
    </script>
</body>
</html>
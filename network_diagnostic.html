<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¿æ¥è¯Šæ–­å·¥å…·</title>
    <script src="/config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å®éªŒå®¤ç®¡ç†ç³»ç»Ÿ - ç½‘ç»œè¿æ¥è¯Šæ–­å·¥å…·</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ</h2>
            <div id="systemStatus">
                <div class="info">æ­£åœ¨æ£€æµ‹ç³»ç»ŸçŠ¶æ€...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸŒ ç½‘ç»œè¿æ¥æµ‹è¯•</h2>
            <button onclick="testConnections()">å¼€å§‹è¿æ¥æµ‹è¯•</button>
            <div id="connectionResults"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ” è¯¦ç»†è¯Šæ–­ä¿¡æ¯</h2>
            <button onclick="showNetworkInfo()">æ˜¾ç¤ºç½‘ç»œä¿¡æ¯</button>
            <div id="networkInfo"></div>
        </div>

        <div class="test-section">
            <h2>ğŸš€ å¿«é€Ÿè®¿é—®é“¾æ¥</h2>
            <div>
                <button onclick="openApp('localhost')">æ‰“å¼€åº”ç”¨ (localhost)</button>
                <button onclick="openApp('ip')">æ‰“å¼€åº”ç”¨ (IPåœ°å€)</button>
                <button onclick="testAPI()">æµ‹è¯•APIè¿æ¥</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ’¡ é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2>
            <div id="solutions">
                <div class="info">
                    <strong>å¸¸è§è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                    1. ç¡®ä¿å‰ç«¯å’Œåç«¯æœåŠ¡å™¨éƒ½åœ¨è¿è¡Œ<br>
                    2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®ï¼Œå…è®¸ç«¯å£3000å’Œ8000<br>
                    3. ç¡®ä¿è®¾å¤‡è¿æ¥åˆ°åŒä¸€WiFiç½‘ç»œ<br>
                    4. å°è¯•é‡å¯æœåŠ¡å™¨<br>
                    5. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®åŠ è½½çŠ¶æ€ç®¡ç†
        let configLoaded = false;
        let configLoadTimeout = null;
        let configSource = 'é»˜è®¤é…ç½®';

        // ç­‰å¾…AppConfigåŠ è½½å®Œæˆ
        function waitForAppConfig(callback) {
            if (window.AppConfig && (window.AppConfig.apiUrl || window.AppConfig.frontendUrl)) {
                configLoaded = true;
                configSource = 'config.js';
                callback();
            } else {
                // è®¾ç½®é»˜è®¤é…ç½®ï¼Œä»¥é˜²config.jsåŠ è½½å¤±è´¥
                if (!window.AppConfig) {
                    const currentHost = window.location.hostname === 'localhost' || window.location.hostname === '' ? 'localhost' : window.location.hostname;
                    window.AppConfig = {
                        apiUrl: currentHost,
                        apiPort: '8000',
                        frontendPort: '3000'
                    };
                }
                
                // å°è¯•ç­‰å¾…é…ç½®åŠ è½½
                setTimeout(() => waitForAppConfig(callback), 100);
                
                // è®¾ç½®è¶…æ—¶å¤„ç†
                if (!configLoadTimeout) {
                    configLoadTimeout = setTimeout(() => {
                        console.warn('é…ç½®åŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                        configLoaded = true;
                        configSource = 'é»˜è®¤é…ç½®';
                        callback();
                    }, 3000);
                }
            }
        }
        
        // åŠ¨æ€åŠ è½½config.js
        function loadConfigJs() {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥config.jsæ˜¯å¦å·²ç»åŠ è½½
                if (document.querySelector('script[src="config.js"]')) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'config.js';
                script.onload = () => resolve();
                script.onerror = () => {
                    console.warn('config.jsåŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®');
                    reject(new Error('config.jsåŠ è½½å¤±è´¥'));
                };
                document.head.appendChild(script);
            });
        }

        // è·å–APIåŸºç¡€URL
        function getApiBaseUrl() {
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            
            // ä¼˜å…ˆä½¿ç”¨å®Œæ•´çš„apiUrlé…ç½®
            if (window.AppConfig && window.AppConfig.apiUrl && window.AppConfig.apiUrl.includes('://')) {
                return window.AppConfig.apiUrl;
            }
            
            // å…¶æ¬¡ä½¿ç”¨å•ç‹¬é…ç½®çš„apiUrlå’ŒapiPort
            if (window.AppConfig) {
                const host = window.AppConfig.apiUrl || window.location.hostname === '' ? 'localhost' : window.location.hostname;
                const port = window.AppConfig.apiPort || '8000';
                return `${protocol}//${host}:${port}`;
            }
            
            // æœ€åä½¿ç”¨å½“å‰é¡µé¢çš„åè®®å’Œä¸»æœºåä½œä¸ºé»˜è®¤å€¼
            const currentHost = window.location.hostname === '' ? 'localhost' : window.location.hostname;
            
            // é¿å…åœ¨å½“å‰originåé‡å¤æ·»åŠ ç«¯å£å·
            if (window.location.port && window.location.port !== '80' && window.location.port !== '443') {
                // å¦‚æœå½“å‰URLå·²ç»åŒ…å«ç«¯å£ï¼Œå°è¯•ä½¿ç”¨å½“å‰ç«¯å£ä½œä¸ºAPIç«¯å£
                return `${protocol}//${currentHost}:${window.location.port}`;
            }
            
            return `${protocol}//${currentHost}:8000`;
        }

        // è·å–å‰ç«¯åŸºç¡€URL
        function getFrontendBaseUrl() {
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            
            // ä¼˜å…ˆä½¿ç”¨å®Œæ•´çš„frontendUrlé…ç½®
            if (window.AppConfig && window.AppConfig.frontendUrl && window.AppConfig.frontendUrl.includes('://')) {
                return window.AppConfig.frontendUrl;
            }
            
            // å…¶æ¬¡ä½¿ç”¨å•ç‹¬é…ç½®çš„ä¸»æœºå’Œç«¯å£
            if (window.AppConfig) {
                const host = window.location.hostname === '' ? 'localhost' : window.location.hostname;
                const port = window.AppConfig.frontendPort || '3000';
                return `${protocol}//${host}:${port}`;
            }
            
            // æœ€åä½¿ç”¨å½“å‰é¡µé¢çš„åè®®å’Œä¸»æœºåä½œä¸ºé»˜è®¤å€¼
            const currentHost = window.location.hostname === '' ? 'localhost' : window.location.hostname;
            
            // é¿å…åœ¨å½“å‰originåé‡å¤æ·»åŠ ç«¯å£å·
            if (window.location.port && window.location.port !== '80' && window.location.port !== '443') {
                // å¦‚æœå½“å‰URLå·²ç»åŒ…å«ç«¯å£ï¼Œå°è¯•ä½¿ç”¨å½“å‰ç«¯å£ä½œä¸ºå‰ç«¯ç«¯å£
                return `${protocol}//${currentHost}:${window.location.port}`;
            }
            
            return `${protocol}//${currentHost}:3000`;
        }

        // è·å–localhostå‰ç«¯åœ°å€
        function getLocalhostFrontendUrl() {
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            const port = window.AppConfig && window.AppConfig.frontendPort ? window.AppConfig.frontendPort : '3000';
            return `${protocol}//localhost:${port}`;
        }
        
        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        function showConfigInfo() {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é…ç½®ä¿¡æ¯åŒºåŸŸ
            if (document.getElementById('configInfo')) {
                return;
            }
            
            // åˆ›å»ºä¸€ä¸ªé…ç½®ä¿¡æ¯åŒºåŸŸ
            const configSection = document.createElement('div');
            configSection.id = 'configInfo';
            configSection.className = 'test-section';
            configSection.innerHTML = `
                <h2><i class="bi bi-gear"></i> é…ç½®ä¿¡æ¯</h2>
                <pre>
é…ç½®æ¥æº: ${configSource}
APIåŸºç¡€URL: ${getApiBaseUrl()}
å‰ç«¯URL: ${getFrontendBaseUrl()}
Localhost URL: ${getLocalhostFrontendUrl()}
ä½¿ç”¨é…ç½®: ${configLoaded ? 'å·²åŠ è½½AppConfig' : 'é»˜è®¤é…ç½®'}
å½“å‰åè®®: ${window.location.protocol === 'https:' ? 'https:' : 'http:'}
å½“å‰ä¸»æœº: ${window.location.hostname}
å½“å‰ç«¯å£: ${window.location.port || 'é»˜è®¤'}
                </pre>
            `;
            
            // å°†é…ç½®ä¿¡æ¯åŒºåŸŸæ·»åŠ åˆ°é¡µé¢é¡¶éƒ¨
            const mainContainer = document.querySelector('.container');
            const firstSection = mainContainer.querySelector('.test-section');
            mainContainer.insertBefore(configSection, firstSection);
        }
        
        // è·å–å½“å‰ç½‘ç»œä¿¡æ¯
        function showNetworkInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'å½“å‰URL': window.location.href,
                'åè®®': window.location.protocol,
                'ä¸»æœº': window.location.host,
                'ç«¯å£': window.location.port || 'é»˜è®¤',
                'æ—¶é—´': new Date().toLocaleString(),
                'è¯­è¨€': navigator.language,
                'åœ¨çº¿çŠ¶æ€': navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿',
                'APIåŸºç¡€URL': getApiBaseUrl(),
                'å‰ç«¯URL': getFrontendBaseUrl(),
                'Localhost URL': getLocalhostFrontendUrl(),
                'é…ç½®æ¥æº': configLoaded ? 'å·²åŠ è½½AppConfig' : 'ä½¿ç”¨é»˜è®¤é…ç½®'
            };
            
            let html = '<pre>';
            for (const [key, value] of Object.entries(info)) {
                html += `${key}: ${value}\n`;
            }
            html += '</pre>';
            
            document.getElementById('networkInfo').innerHTML = html;
        }

        // æµ‹è¯•è¿æ¥
        function testConnections() {
            const results = document.getElementById('connectionResults');
            results.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>';
            
            waitForAppConfig(() => {
                try {
                    const apiBase = getApiBaseUrl();
                    const frontendBase = getFrontendBaseUrl();
                    const localhostFrontend = getLocalhostFrontendUrl();
                    
                    const tests = [
                        { name: 'åç«¯å¥åº·æ£€æŸ¥', url: `${apiBase}/health` },
                        { name: 'å‰ç«¯åº”ç”¨ (IP)', url: frontendBase },
                        { name: 'å‰ç«¯åº”ç”¨ (localhost)', url: localhostFrontend },
                        { name: 'APIç”¨æˆ·æ¥å£', url: `${apiBase}/api/users/me` }
                    ];
                
                let html = '';
                
                for (const test of tests) {
                    try {
                        const startTime = Date.now();
                        fetch(test.url, { 
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        })
                        .then(response => {
                            const endTime = Date.now();
                            const responseTime = endTime - startTime;
                            
                            if (response.ok) {
                                html += `<div class="success">âœ… ${test.name}: æˆåŠŸ (${response.status}) - ${responseTime}ms</div>`;
                            } else {
                                html += `<div class="warning">âš ï¸ ${test.name}: HTTP ${response.status} - ${responseTime}ms</div>`;
                            }
                        })
                        .catch(error => {
                            html += `<div class="error">âŒ ${test.name}: å¤±è´¥ - ${error.message}</div>`;
                        });
                    } catch (error) {
                        html += `<div class="error">âŒ ${test.name}: å¤±è´¥ - ${error.message}</div>`;
                    }
                }
                
                // æ·»åŠ é…ç½®æ¥æºæ˜¾ç¤º
                setTimeout(() => {
                    html += `<div class="config-info">é…ç½®æ¥æº: ${configLoaded ? 'å·²åŠ è½½AppConfig' : 'ä½¿ç”¨é»˜è®¤é…ç½®'}</div>`;
                    results.innerHTML = html;
                }, 1500);
            } catch (error) {
                results.innerHTML = `<div class="error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            });
        }

        // æµ‹è¯•API
        async function testAPI() {
            try {
                // ç¡®ä¿AppConfigå·²ç»åŠ è½½
                await waitForAppConfig();
                
                const apiBase = getApiBaseUrl();
                const response = await fetch(`${apiBase}/health`);
                const data = await response.json();
                alert(`APIæµ‹è¯•æˆåŠŸï¼\\nçŠ¶æ€: ${data.status}\\næ•°æ®åº“: ${data.database}\\næ—¶é—´: ${data.timestamp}\\nAPIåœ°å€: ${apiBase}`);
            } catch (error) {
                alert(`APIæµ‹è¯•å¤±è´¥: ${error.message}\\nè¯·æ£€æŸ¥config.jsæ–‡ä»¶æ˜¯å¦æ­£ç¡®é…ç½®`);
            }
        }

        // æ‰“å¼€åº”ç”¨
        function openApp(type) {
            let url = '';
            if (type === 'localhost') {
                url = getLocalhostFrontendUrl();
            } else {
                url = getFrontendBaseUrl();
            }
            
            window.open(url, '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
        window.onload = function() {
            // å°è¯•åŠ¨æ€åŠ è½½config.js
            loadConfigJs().catch(() => {
                // config.jsåŠ è½½å¤±è´¥ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
                if (!window.AppConfig) {
                    const currentHost = window.location.hostname === 'localhost' || window.location.hostname === '' ? 'localhost' : window.location.hostname;
                    window.AppConfig = {
                        apiUrl: currentHost,
                        apiPort: '8000',
                        frontendPort: '3000'
                    };
                }
            }).finally(() => {
                // ç­‰å¾…é…ç½®åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
                waitForAppConfig(() => {
                    try {
                        // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                        showConfigInfo();
                        
                        showNetworkInfo();
                        
                        // æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
                        const status = document.getElementById('systemStatus');
                        
                        const apiBase = getApiBaseUrl();
                        const frontendBase = getFrontendBaseUrl();
                        const localhostFrontend = getLocalhostFrontendUrl();
                        const currentHost = window.location.hostname;
                        
                        let configInfo = `
                            <div class="info">
                                <strong>å½“å‰é…ç½®:</strong><br>
                                å‰ç«¯åœ°å€: ${frontendBase}<br>
                                åç«¯åœ°å€: ${apiBase}<br>
                                æœ¬åœ°è®¿é—®: ${localhostFrontend}<br>
                                é…ç½®æ¥æº: ${configSource}
                            </div>
                        `;
                        
                        // å¦‚æœä½¿ç”¨localhostè®¿é—®ï¼Œæ˜¾ç¤ºæç¤º
                        if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
                            configInfo += `
                                <div class="warning">
                                    <strong>âš ï¸ æ³¨æ„:</strong><br>
                                    å½“å‰ä½¿ç”¨localhostè®¿é—®ï¼Œæ‰‹æœºæ— æ³•é€šè¿‡æ­¤åœ°å€è¿æ¥ã€‚<br>
                                    è¯·ä½¿ç”¨ç”µè„‘çš„å®é™…IPåœ°å€è®¿é—®æ­¤é¡µé¢ã€‚
                                </div>
                            `;
                        }
                        
                        status.innerHTML = configInfo;
                        
                        // è‡ªåŠ¨è¿è¡Œè¿æ¥æµ‹è¯•
                        setTimeout(testConnections, 1000);
                    } catch (error) {
                        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                    }
                });
            });
        };
    </script>
</body>
</html>
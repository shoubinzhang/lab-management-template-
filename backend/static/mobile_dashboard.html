<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实验室管理系统 - 移动端</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="mobile_nav_styles.css?v=2" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 70px;
        }
        
        .mobile-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 20px 20px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .mobile-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .function-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .function-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .function-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .function-item i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;
            padding: 10px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }
        
        .nav-item {
            text-align: center;
            padding: 8px;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            flex: 1;
            margin: 0 5px;
        }
        
        .nav-item:hover, .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .nav-item i {
            font-size: 1.2rem;
            display: block;
            margin-bottom: 2px;
        }
        
        .nav-item span {
            font-size: 0.8rem;
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-scan {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .alert-mobile {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 2000;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <!-- 移动端主页 -->
    <div id="mobile-dashboard" class="container-fluid">
        <!-- 头部 -->
        <div class="mobile-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0 text-primary">实验室管理系统</h4>
                    <small class="text-muted">移动端</small>
                </div>
                <div class="text-end">
                    <div id="user-info" class="small">
                        <div id="username" class="fw-bold">用户</div>
                        <div id="user-role" class="text-muted">角色</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="mobile-card">
            <h6 class="mb-3 text-primary"><i class="bi bi-graph-up"></i> 快速统计</h6>
            <div class="stats-grid">
                <div class="stat-item">
                    <div id="device-count" class="stat-number">-</div>
                    <div class="stat-label">设备总数</div>
                </div>
                <div class="stat-item">
                    <div id="available-count" class="stat-number">-</div>
                    <div class="stat-label">可用设备</div>
                </div>
                <div class="stat-item">
                    <div id="reagent-count" class="stat-number">-</div>
                    <div class="stat-label">试剂种类</div>
                </div>
                <div class="stat-item">
                    <div id="low-stock-count" class="stat-number">-</div>
                    <div class="stat-label">库存不足</div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn btn-refresh" onclick="refreshStats()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
                <button class="action-btn btn-scan" onclick="openScanner()">
                    <i class="bi bi-qr-code-scan"></i> 扫码
                </button>
            </div>
        </div>

        <!-- 功能菜单 -->
        <div class="mobile-card">
            <h6 class="mb-3 text-primary"><i class="bi bi-grid"></i> 功能菜单</h6>
            <div class="function-grid">
                <div class="function-item" onclick="navigateTo('/static/devices')">
                    <i class="bi bi-cpu"></i>
                    <div>设备管理</div>
                    <small>设备列表与状态</small>
                </div>
                <div class="function-item" onclick="navigateTo('/static/reagents')">
                    <i class="bi bi-flask-conical" style="font-size: 1.4rem; color: white;"></i>
                    <div>试剂管理</div>
                    <small>试剂库存管理</small>
                </div>
                <div class="function-item" onclick="navigateTo('reservations')">
                    <i class="bi bi-calendar-check"></i>
                    <div>预约管理</div>
                    <small>设备预约系统</small>
                </div>
                <div class="function-item" onclick="navigateTo('maintenance')">
                    <i class="bi bi-tools"></i>
                    <div>维护管理</div>
                    <small>维护记录与提醒</small>
                </div>
                <div class="function-item" onclick="navigateTo('/static/records')">
                    <i class="bi bi-journal-text"></i>
                    <div>使用记录</div>
                    <small>设备使用历史</small>
                </div>
                <div class="function-item" onclick="navigateTo('/static/consumables')">
                    <i class="bi bi-box-seam"></i>
                    <div>耗材管理</div>
                    <small>耗材库存管理</small>
                </div>
            </div>
        </div>

        <!-- 快捷操作 -->
        <div class="mobile-card">
            <h6 class="mb-3 text-primary"><i class="bi bi-lightning"></i> 快捷操作</h6>
            <div class="row g-2">
                <div class="col-6">
                    <button class="btn btn-success w-100" onclick="quickAction('add-device')">
                        <i class="bi bi-plus-circle"></i> 添加设备
                    </button>
                </div>
                <div class="col-6">
                    <button class="btn btn-info w-100" onclick="quickAction('add-reagent')">
                        <i class="bi bi-plus-circle"></i> 添加试剂
                    </button>
                </div>
                <div class="col-6">
                    <button class="btn btn-warning w-100" onclick="navigateTo('maintenance')">
                        <i class="bi bi-wrench"></i> 维护记录
                    </button>
                </div>
                <div class="col-6">
                    <button class="btn btn-secondary w-100" onclick="navigateTo('reservations')">
                        <i class="bi bi-calendar-plus"></i> 预约设备
                    </button>
                </div>
            </div>
        </div>

        <!-- 系统状态 -->
        <div class="mobile-card">
            <h6 class="mb-3 text-primary"><i class="bi bi-info-circle"></i> 系统状态</h6>
            <div class="row">
                <div class="col-6">
                    <div class="d-flex align-items-center mb-2">
                        <div id="api-status" class="badge bg-secondary">API状态</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="d-flex align-items-center mb-2">
                        <div id="server-time" class="small text-muted">服务器时间</div>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> 退出登录
                </button>
            </div>
        </div>
    </div>

    <!-- 功能页面 -->
    <div id="device-page" class="container-fluid hidden">
        <div class="mobile-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-primary"><i class="bi bi-cpu"></i> 设备管理</h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="showDashboard()">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
            </div>
            <div id="device-list" class="device-list">
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div class="mt-2 text-muted">正在加载设备列表...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 扫码页面 -->
    <div id="scan-page" class="container-fluid hidden">
        <div class="mobile-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-primary"><i class="bi bi-qr-code-scan"></i> 扫码功能</h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="showDashboard()">
                    <i class="bi bi-arrow-left"></i> 返回
                </button>
            </div>
            <div class="text-center">
                <div class="mb-3">
                    <video id="scan-video" style="width: 100%; max-width: 300px; border-radius: 10px;" autoplay></video>
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-success" onclick="startScan()">
                        <i class="bi bi-play"></i> 开始扫描
                    </button>
                    <button class="action-btn btn-danger" onclick="stopScan()">
                        <i class="bi bi-stop"></i> 停止扫描
                    </button>
                </div>
                <div id="scan-result" class="mt-3"></div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- 引入配置文件 -->
    <script src="/static/js/config.js"></script>
    <script src="/static/js/connection-monitor.js"></script>
    <script>
        // 全局变量
        let currentUser = null;
        let authToken = null;
        let scanStream = null;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // 初始化应用
        async function initializeApp() {
            try {
                // 获取认证令牌，同时兼容网页端和移动端的键名
                function getAuthToken() {
                    // 首先尝试从localStorage获取令牌，兼容多种可能的键名
                    const savedToken = localStorage.getItem('authToken') || localStorage.getItem('token') || localStorage.getItem('access_token');
                    if (savedToken) {
                        // 确保同时保存到所有可能的键名，保持一致性
                        if (!localStorage.getItem('authToken')) {
                            localStorage.setItem('authToken', savedToken);
                        }
                        if (!localStorage.getItem('token')) {
                            localStorage.setItem('token', savedToken);
                        }
                        if (!localStorage.getItem('access_token')) {
                            localStorage.setItem('access_token', savedToken);
                        }
                        return savedToken;
                    }
                    
                    // 尝试从URL参数获取令牌
                    const urlParams = new URLSearchParams(window.location.search);
                    const token = urlParams.get('token');
                    if (token) {
                        // 保存到localStorage以便后续使用，同时保存到两个键名
                        localStorage.setItem('authToken', token);
                        localStorage.setItem('token', token);
                        return token;
                    }
                    
                    // 未找到有效token，重定向到登录页面
                    console.warn('未找到有效token，重定向到登录页面');
                    setTimeout(() => {
                        window.location.href = '/static/mobile_login_final.html';
                    }, 1000);
                    return null;
                }
                
                // 检查登录状态并获取认证令牌
                authToken = getAuthToken();
                
                // 如果未获取到有效token，直接返回，等待重定向
                if (!authToken) {
                    console.warn('未获取到有效token，等待重定向到登录页面');
                    return;
                }
                
                // 尝试从localStorage读取保存的用户信息，兼容多种可能的键名
                try {
                    const userInfoJson = localStorage.getItem('userInfo') || localStorage.getItem('user');
                    if (userInfoJson) {
                        currentUser = JSON.parse(userInfoJson);
                        console.log('从localStorage读取用户信息成功:', currentUser);
                    } else {
                        console.log('localStorage中未找到用户信息');
                    }
                } catch (parseError) {
                    console.warn('解析用户信息失败:', parseError);
                }
                
                let hasRealData = false;
                
                // 首先尝试加载真实数据
                try {
                    await Promise.all([
                        loadUserInfo(),
                        loadStats(),
                        // 同时加载设备列表数据以确保数据同步
                        loadDeviceList()
                    ]);
                    hasRealData = true;
                } catch (apiError) {
                    console.warn('API调用失败，将使用模拟数据:', apiError);
                }
                
                // 如果真实数据加载失败，直接抛出错误而不是使用模拟数据
                if (!hasRealData) {
                    throw new Error('无法连接到服务器，请检查网络连接');
                }
                
                // 添加数据已更新的通知
                if (hasRealData) {
                    setTimeout(() => {
                        showToast('success', '数据已更新为最新状态');
                    }, 1000);
                }
                
                // 更新服务器时间
                updateServerTime();
                setInterval(updateServerTime, 60000); // 每分钟更新一次
                
            } catch (error) {
                console.error('应用初始化失败:', error);
                // 直接显示错误信息，不使用模拟数据
                showToast('error', '系统初始化失败: ' + error.message);
                throw error; // 重新抛出错误，让调用方处理
            }
        }

        // 加载模拟用户信息
        function loadMockUserInfo() {
            currentUser = {
                id: 1,
                username: '实验室管理员',
                role: 'lab_manager',
                department: '研发部',
                name: '张三'
            };
            
            // 更新UI
            document.getElementById('username').textContent = currentUser.username;
            document.getElementById('user-role').textContent = getRoleName(currentUser.role);
        }
        
        // 加载模拟统计数据
        function loadMockStats() {
            // 更新UI
            document.getElementById('device-count').textContent = '25';
            document.getElementById('available-count').textContent = '18';
            document.getElementById('reagent-count').textContent = '156';
            document.getElementById('low-stock-count').textContent = '12';
            
            // 保持API状态为已连接以避免用户困惑
            updateApiStatus(true);
        }

        // 加载用户信息
        async function loadUserInfo() {
            try {
                // 添加超时控制，防止请求长时间阻塞
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), AppConfig.api.timeout);
                
                const response = await fetch(AppConfig.getApiUrl('auth/me'), {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`获取用户信息失败: ${response.status}`);
                }
                
                const userData = await response.json();
                currentUser = userData;
                
                // 更新UI
                document.getElementById('username').textContent = userData.username;
                document.getElementById('user-role').textContent = getRoleName(userData.role);
                
                return userData; // 返回数据表示成功
            } catch (error) {
                console.error('加载用户信息失败:', error);
                throw error; // 重新抛出异常，让Promise.all能够捕获
            }
        }

        // 获取角色中文名
        function getRoleName(role) {
            const roleMap = {
                'admin': '管理员',
                'user': '普通用户',
                'lab_manager': '实验室管理员',
                'researcher': '研究员'
            };
            return roleMap[role] || role;
        }

        // 加载统计数据
        async function loadStats() {
            try {
                // 添加超时控制，防止请求长时间阻塞
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), AppConfig.api.timeout);
                
                const response = await fetch(AppConfig.getApiUrl('dashboard/quick-stats'), {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`获取统计数据失败: ${response.status}`);
                }
                
                const stats = await response.json();
                
                // 更新UI
                document.getElementById('device-count').textContent = stats.device_count || 0;
                document.getElementById('available-count').textContent = stats.available_devices || 0;
                document.getElementById('reagent-count').textContent = stats.reagent_count || 0;
                document.getElementById('low-stock-count').textContent = stats.low_stock_reagents || 0;
                
                // 更新API状态
                updateApiStatus(true);
                
                return stats; // 返回数据表示成功
            } catch (error) {
                console.error('加载统计数据失败:', error);
                updateApiStatus(false); // 在失败时正确更新API状态
                throw error; // 重新抛出异常，让Promise.all能够捕获
            }
        }

        // 更新API状态
        function updateApiStatus(isConnected) {
            const statusElement = document.getElementById('api-status');
            if (isConnected) {
                statusElement.className = 'badge bg-success';
                statusElement.textContent = '已连接';
            } else {
                statusElement.className = 'badge bg-danger';
                statusElement.textContent = '未连接';
            }
        }

        // 更新服务器时间
        function updateServerTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('server-time').textContent = `系统时间: ${timeString}`;
        }

        // 刷新统计数据
        async function refreshStats() {
            const refreshBtn = event.target.closest('button');
            refreshBtn.classList.add('loading');
            
            try {
                await loadStats();
                showAlert('success', '统计数据已刷新');
            } catch (error) {
                showAlert('danger', '刷新失败: ' + error.message);
            } finally {
                refreshBtn.classList.remove('loading');
            }
        }

        // 页面导航
        function navigateTo(page) {
            try {
                const pages = {
                    'devices': '/static/mobile_devices.html',
                    'reagents': '/static/mobile_reagents.html',
                    'consumables': '/static/mobile_consumables.html',
                    'reservations': '/static/mobile_reservations.html',
                    'maintenance': '/static/mobile_maintenance.html'
                };
                
                // 检查是否为功能开发中的页面
                const underDevelopment = ['records'];
                if (underDevelopment.includes(page)) {
                    showAlert('info', page === 'maintenance' ? '维护管理功能开发中...' : 
                              '使用记录功能开发中...');
                    return;
                }
                
                // 检查是否为首页
                if (page === 'dashboard') {
                    showDashboard();
                    return;
                }
                
                // 处理页面跳转
                if (pages[page]) {
                    // 确保使用完整的URL路径
                    const targetUrl = window.location.origin + pages[page];
                    
                    // 尝试使用iframe预加载检查文件是否存在
                    const testIframe = document.createElement('iframe');
                    testIframe.style.display = 'none';
                    testIframe.src = targetUrl;
                    testIframe.onload = function() {
                        // 文件存在，执行跳转
                        window.location.href = targetUrl;
                        document.body.removeChild(testIframe);
                    };
                    testIframe.onerror = function() {
                        // 文件不存在或无法访问，显示错误信息
                        showAlert('danger', '页面加载失败，请稍后再试');
                        document.body.removeChild(testIframe);
                    };
                    
                    document.body.appendChild(testIframe);
                    
                    // 添加超时处理，防止长时间等待
                    setTimeout(() => {
                        if (testIframe.parentNode) {
                            document.body.removeChild(testIframe);
                            // 如果超时，尝试直接跳转（可能在某些环境下iframe无法正常工作）
                            window.location.href = targetUrl;
                        }
                    }, 2000);
                } else {
                    // 默认显示首页
                    showDashboard();
                }
            } catch (error) {
                console.error('页面导航失败:', error);
                showAlert('danger', '页面跳转失败，请稍后再试');
            }
        }

        // 显示主页
        function showDashboard() {
            // 隐藏所有页面
            document.getElementById('mobile-dashboard').classList.remove('hidden');
            document.getElementById('device-page').classList.add('hidden');
            document.getElementById('scan-page').classList.add('hidden');
            
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector('.nav-item').classList.add('active');
            
            // 刷新数据
            loadStats();
        }

        // 显示设备页面
        function showDevicePage() {
            document.getElementById('mobile-dashboard').classList.add('hidden');
            document.getElementById('device-page').classList.remove('hidden');
            document.getElementById('scan-page').classList.add('hidden');
            
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            
            // 加载设备列表
            loadDeviceList();
        }

        // 显示扫码页面
        function showScanPage() {
            window.location.href = "/static/mobile_scan.html";
        }

        // 显示试剂页面
        function showReagentPage() {
            showAlert('info', '试剂管理功能开发中...');
        }

        // 显示预约页面
        function showReservationPage() {
            navigateTo('reservations');
        }

        // 显示维护页面
        function showMaintenancePage() {
            navigateTo('maintenance');
        }

        // 显示记录页面
        function showRecordsPage() {
            showAlert('info', '使用记录功能开发中...');
        }

        // 显示耗材页面
        function showConsumablesPage() {
            showAlert('info', '耗材管理功能开发中...');
        }

        // 显示用户菜单
        function showUserMenu() {
            showAlert('info', '用户菜单功能开发中...');
        }

        // 加载设备列表
        async function loadDeviceList() {
            const deviceList = document.getElementById('device-list');
            deviceList.innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div class="mt-2 text-muted">正在加载设备列表...</div>
                </div>
            `;
            
            try {
                const response = await fetch(AppConfig.getApiUrl('devices'), {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取设备列表失败');
                }
                
                const devices = await response.json();
                
                if (devices.devices && devices.devices.length > 0) {
                    let html = '<div class="device-grid">';
                    devices.devices.forEach(device => {
                        const statusClass = getDeviceStatusClass(device.status);
                        html += `
                            <div class="device-card">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">${device.name}</h6>
                                    <span class="badge ${statusClass}">${getDeviceStatusName(device.status)}</span>
                                </div>
                                <div class="small text-muted">
                                    <div><i class="bi bi-geo-alt"></i> ${device.location || '未指定位置'}</div>
                                    <div><i class="bi bi-tag"></i> ${device.model || '未指定型号'}</div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewDeviceDetails(${device.id})">
                                        <i class="bi bi-eye"></i> 详情
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    deviceList.innerHTML = html;
                } else {
                    deviceList.innerHTML = `
                        <div class="text-center p-4 text-muted">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <div class="mt-2">暂无设备数据</div>
                        </div>
                    `;
                }
                
                console.log('设备列表加载完成:', devices);
            } catch (error) {
                console.error('加载设备列表失败:', error);
                deviceList.innerHTML = `
                    <div class="text-center p-4 text-danger">
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                        <div class="mt-2">加载失败: ${error.message}</div>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadDeviceList()">
                            <i class="bi bi-arrow-clockwise"></i> 重试
                        </button>
                    </div>
                `;
            }
        }

        // 获取设备状态样式
        function getDeviceStatusClass(status) {
            const statusMap = {
                'available': 'bg-success',
                'in_use': 'bg-warning',
                'maintenance': 'bg-danger',
                'damaged': 'bg-dark',
                'retired': 'bg-secondary'
            };
            return statusMap[status] || 'bg-secondary';
        }

        // 获取设备状态名称
        function getDeviceStatusName(status) {
            const statusMap = {
                'available': '可用',
                'in_use': '使用中',
                'maintenance': '维护中',
                'damaged': '已损坏',
                'retired': '已退役'
            };
            return statusMap[status] || '未知状态';
        }

        // 查看设备详情
        function viewDeviceDetails(deviceId) {
            showAlert('info', `设备详情功能开发中... (设备ID: ${deviceId})`);
        }

        // 快捷操作 - 已集成到导航按钮中

        // 打开扫码
        function openScanner() {
            window.location.href = "/static/mobile_scan.html";
        }

        // 开始扫码
        async function startScan() {
            try {
                const video = document.getElementById('scan-video');
                const resultDiv = document.getElementById('scan-result');
                
                // 获取摄像头权限
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                scanStream = stream;
                video.srcObject = stream;
                
                resultDiv.innerHTML = '<div class="text-success">正在扫描中...</div>';
                
                // 开始扫描循环
                scanQRCode(video, resultDiv);
                
            } catch (error) {
                console.error('扫码启动失败:', error);
                showAlert('danger', '无法启动摄像头: ' + error.message);
            }
        }

        // 扫描二维码
        function scanQRCode(video, resultDiv) {
            if (!scanStream) return;
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            if (canvas.width > 0 && canvas.height > 0) {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>扫描成功!</strong>
                            <div class="mt-2">${code.data}</div>
                            <button class="btn btn-primary btn-sm mt-2" onclick="processQRResult('${code.data}')">处理数据</button>
                        </div>
                    `;
                    stopScan();
                    return;
                }
            }
            
            // 继续扫描
            if (scanStream) {
                requestAnimationFrame(() => scanQRCode(video, resultDiv));
            }
        }

        // 停止扫码
        function stopScan() {
            if (scanStream) {
                scanStream.getTracks().forEach(track => track.stop());
                scanStream = null;
            }
            
            const video = document.getElementById('scan-video');
            video.srcObject = null;
            
            document.getElementById('scan-result').innerHTML = '<div class="text-muted">扫描已停止</div>';
        }

        // 处理二维码结果
        function processQRResult(data) {
            showAlert('success', '正在处理: ' + data);
            // 这里可以添加具体的处理逻辑
        }

        // 显示用户菜单
        function showUserMenu() {
            const menuHtml = `
                <div class="modal fade" id="userMenuModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">用户菜单</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    <button class="list-group-item list-group-item-action" onclick="showUserInfo()">
                                        <i class="bi bi-person-circle"></i> 个人信息
                                    </button>
                                    <button class="list-group-item list-group-item-action" onclick="showSettings()">
                                        <i class="bi bi-gear"></i> 设置
                                    </button>
                                    <button class="list-group-item list-group-item-action" onclick="showHelp()">
                                        <i class="bi bi-question-circle"></i> 帮助
                                    </button>
                                    <button class="list-group-item list-group-item-action text-danger" onclick="logout()">
                                        <i class="bi bi-box-arrow-right"></i> 退出登录
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('userMenuModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', menuHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('userMenuModal'));
            modal.show();
            
            document.getElementById('userMenuModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        // 显示用户信息
        function showUserInfo() {
            if (currentUser) {
                showAlert('info', `
                    <strong>用户信息</strong><br>
                    用户名: ${currentUser.username}<br>
                    邮箱: ${currentUser.email}<br>
                    角色: ${getRoleName(currentUser.role)}
                `);
            }
        }

        // 显示设置
        function showSettings() {
            showAlert('info', '设置功能开发中...');
        }

        // 显示帮助
        function showHelp() {
            showAlert('info', `
                <strong>使用帮助</strong><br>
                1. 点击功能图标使用对应功能<br>
                2. 扫码功能可以扫描二维码<br>
                3. 下拉可以刷新数据<br>
                4. 有问题请联系管理员
            `);
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                localStorage.removeItem('tokenType');
                window.location.href = "/static/mobile_login_final.html";
            }
        }

        // Toast通知系统 - 保持与其他页面一致性，参数顺序为(message, type)
        function showToast(message, type = 'info', duration = 3000) {
            // 兼容性处理：如果调用方式是旧的(type, message)，则交换参数
            if (typeof message === 'string' && ['success', 'error', 'warning', 'info', 'danger'].includes(message)) {
                const temp = message;
                message = type;
                type = temp;
            }
            
            // 检查是否已存在toast容器，不存在则创建
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.position = 'fixed';
                toastContainer.style.top = '20px';
                toastContainer.style.right = '20px';
                toastContainer.style.zIndex = '9999';
                toastContainer.style.display = 'flex';
                toastContainer.style.flexDirection = 'column';
                toastContainer.style.gap = '10px';
                document.body.appendChild(toastContainer);
            }
            
            // 创建toast元素
            const toast = document.createElement('div');
            
            // 根据类型设置背景色
            const bgColors = {
                success: 'rgba(40, 167, 69, 0.95)',
                error: 'rgba(220, 53, 69, 0.95)',
                warning: 'rgba(255, 193, 7, 0.95)',
                info: 'rgba(23, 162, 184, 0.95)',
                danger: 'rgba(220, 53, 69, 0.95)'
            };
            
            // 根据类型设置图标
            const icons = {
                success: 'bi-check-circle',
                error: 'bi-exclamation-circle',
                warning: 'bi-exclamation-triangle',
                info: 'bi-info-circle',
                danger: 'bi-exclamation-circle'
            };
            
            toast.style.backgroundColor = bgColors[type] || bgColors.info;
            toast.style.color = 'white';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '8px';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.gap = '10px';
            toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            toast.style.maxWidth = '350px';
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            toast.style.cursor = 'pointer';
            
            toast.innerHTML = `
                <i class="bi ${icons[type] || icons.info}" style="font-size: 1.2rem;"></i>
                <span>${message}</span>
            `;
            
            // 添加到容器
            toastContainer.appendChild(toast);
            
            // 触发动画
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // 点击关闭
            toast.addEventListener('click', () => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            });
            
            // 自动关闭
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        // 为了兼容性保留showAlert函数，但内部调用showToast
        function showAlert(type, message) {
            // 将bootstrap的alert类型映射到toast类型
            const typeMap = {
                success: 'success',
                danger: 'error',
                warning: 'warning',
                info: 'info'
            };
            showToast(message, typeMap[type] || 'info');
        }

        // 添加CSS样式
        const additionalStyles = `
            .device-list {
                max-height: 60vh;
                overflow-y: auto;
            }
            
            .device-card {
                background: rgba(255, 255, 255, 0.9);
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .device-grid {
                display: grid;
                gap: 10px;
            }
            
            .loading {
                opacity: 0.6;
                pointer-events: none;
            }
            
            .loading .spinner-border {
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
    </script>
    
    <!-- 底部导航栏 - 统一所有按钮在一排 -->
    <nav class="bottom-nav">
        <a href="/static/mobile_index.html" class="nav-item">
            <i class="bi bi-house"></i>
            <span>首页</span>
        </a>
        <a href="/static/mobile_devices.html" class="nav-item">
            <i class="bi bi-microchip"></i>
            <span>设备</span>
        </a>
        <a href="/static/mobile_reagents.html" class="nav-item">
            <i class="bi bi-flask"></i>
            <span>试剂</span>
        </a>
        <a href="/static/mobile_consumables.html" class="nav-item">
            <i class="bi bi-cart"></i>
            <span>耗材</span>
        </a>
        <a href="/static/mobile_scan.html" class="nav-item">
            <i class="bi bi-qr-code-scan"></i>
            <span>扫码</span>
        </a>
        <a href="/static/mobile_reservations.html" class="nav-item">
            <i class="bi bi-calendar-check"></i>
            <span>预约</span>
        </a>
        <a href="/static/mobile_maintenance.html" class="nav-item">
            <i class="bi bi-tools"></i>
            <span>维护</span>
        </a>
        <a href="/static/mobile_user.html" class="nav-item">
            <i class="bi bi-person"></i>
            <span>用户</span>
        </a>
    </nav>
    
    <style>
        .function-extension {
            display: flex;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            overflow-x: auto;
            white-space: nowrap;
        }
        .function-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
            color: #6c757d;
            text-decoration: none;
            font-size: 0.85rem;
        }
        .function-item i {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        .function-item:hover {
            color: #0d6efd;
        }
    </style>
</body>
</html>
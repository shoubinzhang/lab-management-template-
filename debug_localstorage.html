<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalStorage 调试工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .key-item { margin: 5px 0; padding: 5px; background: #f5f5f5; }
        .value { font-family: monospace; word-break: break-all; }
        .action-btn { margin: 10px 5px; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .clear-btn { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>LocalStorage 调试工具</h1>
        
        <div class="section">
            <h3>当前 LocalStorage 内容</h3>
            <div id="storage-content"></div>
            <button class="action-btn" onclick="refreshStorage()">刷新</button>
            <button class="action-btn clear-btn" onclick="clearStorage()">清除所有</button>
        </div>
        
        <div class="section">
            <h3>测试移动端登录</h3>
            <button class="action-btn" onclick="testMobileLogin()">模拟移动端登录</button>
            <button class="action-btn" onclick="testMobileDashboard()">测试移动端仪表盘</button>
        </div>
        
        <div class="section">
            <h3>API 测试</h3>
            <button class="action-btn" onclick="testAuthAPI()">测试认证API</button>
            <button class="action-btn" onclick="testStatsAPI()">测试统计API</button>
            <div id="api-result"></div>
        </div>
    </div>
    
    <script>
        // 显示当前localStorage内容
        function displayStorage() {
            const contentDiv = document.getElementById('storage-content');
            contentDiv.innerHTML = '';
            
            const keys = ['authToken', 'token', 'access_token', 'auth_token', 'user', 'userInfo', 'username', 'apiBaseUrl'];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'key-item';
                itemDiv.innerHTML = `<strong>${key}:</strong> <span class="value">${value || '(未设置)'}</span>`;
                contentDiv.appendChild(itemDiv);
            });
        }
        
        // 刷新存储内容
        function refreshStorage() {
            displayStorage();
        }
        
        // 清除所有localStorage
        function clearStorage() {
            if (confirm('确定要清除所有localStorage数据吗？')) {
                localStorage.clear();
                displayStorage();
                alert('已清除所有localStorage数据');
            }
        }
        
        // 模拟移动端登录
        function testMobileLogin() {
            // 模拟登录成功后的数据存储
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsIm5hbWUiOiLkuK3lm73ml6XmnKwiLCJpYXQiOjE2MjAzNDU2MDAsInJvbGUiOiJhZG1pbiJ9.real-token-signature';
            const userInfo = {
                username: 'admin',
                role: 'admin',
                name: '系统管理员'
            };
            
            // 保存到所有可能的键名
            localStorage.setItem('authToken', mockToken);
            localStorage.setItem('token', mockToken);
            localStorage.setItem('access_token', mockToken);
            localStorage.setItem('auth_token', mockToken);
            localStorage.setItem('user', 'admin');
            localStorage.setItem('userInfo', JSON.stringify(userInfo));
            localStorage.setItem('username', 'admin');
            localStorage.setItem('apiBaseUrl', 'http://172.30.81.97:8000');
            
            displayStorage();
            alert('已模拟移动端登录数据存储');
        }
        
        // 测试移动端仪表盘
        function testMobileDashboard() {
            // 模拟移动端仪表盘的getAuthToken函数逻辑
            function getAuthToken() {
                const savedToken = localStorage.getItem('authToken') || localStorage.getItem('token') || localStorage.getItem('access_token');
                if (savedToken) {
                    console.log('找到token:', savedToken);
                    return savedToken;
                }
                
                console.warn('未找到有效token，应该重定向到登录页面');
                return null;
            }
            
            const token = getAuthToken();
            if (token) {
                alert(`找到token: ${token.substring(0, 50)}...`);
            } else {
                alert('未找到有效token，应该重定向到登录页面');
            }
        }
        
        // 测试认证API
        async function testAuthAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '测试中...';
            
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('token');
                if (!token) {
                    resultDiv.innerHTML = '错误：未找到token';
                    return;
                }
                
                const response = await fetch('http://172.30.81.97:8000/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `API调用成功: ${JSON.stringify(data)}`;
                } else {
                    resultDiv.innerHTML = `API调用失败: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `API调用错误: ${error.message}`;
            }
        }
        
        // 测试统计API
        async function testStatsAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '测试中...';
            
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('token');
                if (!token) {
                    resultDiv.innerHTML = '错误：未找到token';
                    return;
                }
                
                const response = await fetch('http://172.30.81.97:8000/api/dashboard/quick-stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `统计API调用成功: ${JSON.stringify(data)}`;
                } else {
                    resultDiv.innerHTML = `统计API调用失败: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `统计API调用错误: ${error.message}`;
            }
        }
        
        // 页面加载时显示存储内容
        displayStorage();
    </script>
</body>
</html>
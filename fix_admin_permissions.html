<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修复管理员权限</title>
    <script src="config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.danger {
            background: #f44336;
        }
        .button.danger:hover {
            background: #da190b;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #2196f3;
            background: #e3f2fd;
        }
        .success {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .code {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>管理员权限修复工具</h1>
        
        <div id="status" class="status">
            正在检查当前用户状态...
        </div>
        
        <div class="code" id="userInfo">
            用户信息加载中...
        </div>
        
        <h3>修复选项：</h3>
        <button class="button" onclick="fixAdminRole()">1. 设置当前用户为管理员</button>
        <button class="button" onclick="createAdminUser()">2. 创建新的管理员用户</button>
        <button class="button" onclick="refreshUserData()">3. 刷新用户数据</button>
        <button class="button danger" onclick="clearAllData()">4. 清除所有数据并重新登录</button>
        
        <h3>测试选项：</h3>
        <button class="button" onclick="testButtons()">测试按钮显示</button>
        <button class="button" onclick="openReagentsPage()">打开试剂页面</button>
        
        <div id="testResult" style="margin-top: 20px;"></div>
    </div>
    
    <script>
        // 配置加载状态管理
        let configLoaded = false;
        let configLoadTimeout = null;
        
        // 等待AppConfig加载完成
        function waitForAppConfig(callback) {
            if (window.AppConfig && window.AppConfig.apiUrl) {
                configLoaded = true;
                callback();
            } else {
                // 设置默认配置，以防config.js加载失败
                if (!window.AppConfig) {
                    window.AppConfig = {
                        apiUrl: 'localhost',
                        apiPort: '8000',
                        frontendPort: '3000'
                    };
                }
                
                // 尝试等待配置加载
                setTimeout(() => waitForAppConfig(callback), 100);
                
                // 设置超时处理
                if (!configLoadTimeout) {
                    configLoadTimeout = setTimeout(() => {
                        console.warn('配置加载超时，使用默认配置');
                        configLoaded = true;
                        callback();
                    }, 3000);
                }
            }
        }
        
        // 获取前端基础URL
        function getFrontendBaseUrl() {
            if (!window.AppConfig) {
                return 'http://localhost:3000'; // 默认回退
            }
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            const host = window.AppConfig.apiUrl || 'localhost';
            const port = window.AppConfig.frontendPort || '3000';
            return `${protocol}//${host}:${port}`;
        }
        
        // 构建前端完整URL
        function buildFrontendUrl(path = '') {
            const baseUrl = getFrontendBaseUrl();
            return baseUrl + (path.startsWith('/') ? path : '/' + path);
        }
        
        function updateStatus(message, type = 'status') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + type;
            statusDiv.innerHTML = message;
        }
        
        function updateUserInfo(info) {
            document.getElementById('userInfo').innerHTML = info;
        }
        
        function checkCurrentUser() {
            try {
                const userStr = localStorage.getItem('user');
                const tokenStr = localStorage.getItem('token');
                
                if (!userStr) {
                    updateStatus('未找到用户数据，请先登录', 'error');
                    updateUserInfo('localStorage中没有用户数据');
                    return null;
                }
                
                const user = JSON.parse(userStr);
                const isAdmin = user?.role === 'admin';
                
                updateUserInfo(`
用户名: ${user.username || '未知'}
角色: ${user.role || '未设置'}
是否管理员: ${isAdmin ? '是' : '否'}
Token存在: ${tokenStr ? '是' : '否'}

原始数据: ${userStr}
                `);
                
                if (isAdmin) {
                    updateStatus('当前用户已经是管理员，如果按钮仍然不显示，可能是其他问题', 'success');
                } else {
                    updateStatus('当前用户不是管理员，这就是按钮不显示的原因', 'error');
                }
                
                return user;
            } catch (error) {
                updateStatus('检查用户数据时出错: ' + error.message, 'error');
                return null;
            }
        }
        
        function fixAdminRole() {
            try {
                const userStr = localStorage.getItem('user');
                if (!userStr) {
                    updateStatus('未找到用户数据，无法修复', 'error');
                    return;
                }
                
                const user = JSON.parse(userStr);
                user.role = 'admin';
                localStorage.setItem('user', JSON.stringify(user));
                
                updateStatus('用户角色已设置为管理员！', 'success');
                checkCurrentUser();
                
                // 自动刷新试剂页面
                setTimeout(() => {
                    if (confirm('角色已修复，是否立即打开试剂页面查看效果？')) {
                        try {
                            window.open(buildFrontendUrl('reagents'), '_blank');
                        } catch (error) {
                            console.error('打开试剂页面失败:', error);
                            updateStatus('打开页面失败，请稍后再试', 'error');
                        }
                    }
                }, 1000);
                
            } catch (error) {
                updateStatus('修复失败: ' + error.message, 'error');
            }
        }
        
        function createAdminUser() {
            const adminUser = {
                id: 1,
                username: 'admin',
                role: 'admin',
                email: 'admin@example.com'
            };
            
            localStorage.setItem('user', JSON.stringify(adminUser));
            localStorage.setItem('token', 'admin-token-' + Date.now());
            
            updateStatus('已创建管理员用户并登录！', 'success');
            checkCurrentUser();
        }
        
        function refreshUserData() {
            // 模拟从服务器重新获取用户数据
            const currentUser = localStorage.getItem('user');
            if (currentUser) {
                const user = JSON.parse(currentUser);
                // 确保用户有管理员权限
                user.role = 'admin';
                localStorage.setItem('user', JSON.stringify(user));
                updateStatus('用户数据已刷新并设置为管理员', 'success');
                checkCurrentUser();
            } else {
                updateStatus('没有用户数据可以刷新', 'error');
            }
        }
        
        function clearAllData() {
            if (confirm('这将清除所有本地数据，您需要重新登录。确定继续吗？')) {
                localStorage.clear();
                sessionStorage.clear();
                updateStatus('所有数据已清除', 'success');
                updateUserInfo('localStorage已清空');
                
                setTimeout(() => {
                    window.location.href = buildFrontendUrl('login');
                }, 2000);
            }
        }
        
        function testButtons() {
            const user = checkCurrentUser();
            if (!user) return;
            
            const isAdmin = user?.role === 'admin';
            const testDiv = document.getElementById('testResult');
            
            testDiv.innerHTML = `
                <h4>按钮显示测试结果：</h4>
                <div style="padding: 10px; background: #f0f0f0; border-radius: 5px;">
                    <button style="margin: 5px; padding: 5px 10px;">申请按钮（所有用户可见）</button>
                    ${isAdmin ? '<button style="margin: 5px; padding: 5px 10px; background: #4caf50; color: white;">编辑按钮（管理员可见）</button>' : ''}
                    ${isAdmin ? '<button style="margin: 5px; padding: 5px 10px; background: #f44336; color: white;">删除按钮（管理员可见）</button>' : ''}
                </div>
                <p><strong>预期结果：</strong> ${isAdmin ? '应该显示所有三个按钮' : '只应该显示申请按钮'}</p>
            `;
        }
        
        function openReagentsPage() {
            try {
                window.open(buildFrontendUrl('reagents'), '_blank');
            } catch (error) {
                console.error('打开试剂页面失败:', error);
                updateStatus('打开页面失败，请稍后再试', 'error');
            }
        }
        
        // 页面加载时检查用户状态
        window.addEventListener('load', function() {
            waitForAppConfig(() => {
                console.log('配置加载完成，当前前端地址:', getFrontendBaseUrl());
                checkCurrentUser();
            });
        });
    </script>
</body>
</html>
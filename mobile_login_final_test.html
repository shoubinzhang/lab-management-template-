<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§»åŠ¨ç«¯ç™»å½•æµ‹è¯• - æœ€ç»ˆç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: auto;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .test-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
        }
        
        .test-button {
            background: #4CAF50;
            margin-bottom: 10px;
        }
        
        .test-button.connection {
            background: #2196F3;
        }
        
        .test-button.device {
            background: #FF9800;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .result.success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .result.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .result.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }
        
        .device-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .device-info h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-item {
            margin-bottom: 5px;
            color: #666;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
    <script src="/config.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ ç§»åŠ¨ç«¯ç™»å½•æµ‹è¯•</h1>
        
        <div class="device-info">
            <h3>ğŸ“± è®¾å¤‡ä¿¡æ¯</h3>
            <div id="deviceInfo">
                <div class="loading"></div>
            </div>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" value="admin" required>
            </div>
            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" value="admin123" required>
            </div>
            <button type="submit">ç™»å½•</button>
        </form>
        
        <div class="test-section">
            <button class="test-button connection" onclick="testConnection()">æµ‹è¯•ç½‘ç»œè¿æ¥</button>
            <button class="test-button device" onclick="getDeviceInfo()">åˆ·æ–°è®¾å¤‡ä¿¡æ¯</button>
            <button class="test-button" onclick="testFullLogin()">å®Œæ•´ç™»å½•æµ‹è¯•</button>
        </div>
        
        <div id="result" class="result hidden"></div>
    </div>

    <script>
        let AppConfig = {};

        // ç­‰å¾…AppConfigåŠ è½½å®Œæˆ
        function waitForAppConfig() {
            return new Promise((resolve) => {
                if (typeof window.AppConfig !== 'undefined') {
                    AppConfig = window.AppConfig;
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof window.AppConfig !== 'undefined') {
                            clearInterval(checkInterval);
                            AppConfig = window.AppConfig;
                            resolve();
                        }
                    }, 50);
                }
            });
        }

        // è·å–APIåœ°å€
        function getApiUrl() {
            // ç¡®ä¿AppConfigå·²ç»åŠ è½½
            if (typeof AppConfig === 'undefined') {
                console.log('AppConfigå°šæœªåŠ è½½ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                const protocol = window.location.protocol;
                const hostname = window.location.hostname;
                const defaultUrl = `${protocol}//${hostname}:8000`;
                console.log(`ä½¿ç”¨é»˜è®¤API URL: ${defaultUrl}`);
                return defaultUrl;
            }
            
            const apiBaseUrl = AppConfig.api.baseUrl;
            console.log(`ä½¿ç”¨AppConfigé…ç½®çš„APIåŸºç¡€åœ°å€: ${apiBaseUrl}`);
            return apiBaseUrl;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
            resultDiv.classList.remove('hidden');
        }

        // è·å–è®¾å¤‡ä¿¡æ¯
        function getDeviceInfo() {
            const deviceInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                screenWidth: screen.width,
                screenHeight: screen.height,
                windowWidth: window.innerWidth,
                windowHeight: window.innerHeight,
                isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                isTouchDevice: 'ontouchstart' in window,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink
                } : null,
                apiUrl: getApiUrl(),
                timestamp: new Date().toLocaleString('zh-CN')
            };

            const deviceInfoDiv = document.getElementById('deviceInfo');
            deviceInfoDiv.innerHTML = `
                <div class="info-item"><strong>ç”¨æˆ·ä»£ç†:</strong> ${deviceInfo.userAgent}</div>
                <div class="info-item"><strong>å¹³å°:</strong> ${deviceInfo.platform}</div>
                <div class="info-item"><strong>å±å¹•:</strong> ${deviceInfo.screenWidth}x${deviceInfo.screenHeight}</div>
                <div class="info-item"><strong>çª—å£:</strong> ${deviceInfo.windowWidth}x${deviceInfo.windowHeight}</div>
                <div class="info-item"><strong>ç§»åŠ¨è®¾å¤‡:</strong> ${deviceInfo.isMobile ? 'æ˜¯' : 'å¦'}</div>
                <div class="info-item"><strong>è§¦æ‘¸è®¾å¤‡:</strong> ${deviceInfo.isTouchDevice ? 'æ˜¯' : 'å¦'}</div>
                <div class="info-item"><strong>ç½‘ç»œç±»å‹:</strong> ${deviceInfo.connection ? deviceInfo.connection.effectiveType : 'æœªçŸ¥'}</div>
                <div class="info-item"><strong>APIåœ°å€:</strong> ${deviceInfo.apiUrl}</div>
                <div class="info-item"><strong>æ—¶é—´:</strong> ${deviceInfo.timestamp}</div>
            `;

            return deviceInfo;
        }

        // æµ‹è¯•ç½‘ç»œè¿æ¥
        async function testConnection() {
            showResult('æ­£åœ¨æµ‹è¯•ç½‘ç»œè¿æ¥...', 'info');
            
            try {
                // ç­‰å¾…AppConfigåŠ è½½å®Œæˆ
                await waitForAppConfig();
                
                const apiUrl = getApiUrl();
                const healthUrl = AppConfig.getApiUrl('health');
                
                const response = await fetch(healthUrl);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`âœ… ç½‘ç»œè¿æ¥æˆåŠŸï¼<br>æœåŠ¡å™¨çŠ¶æ€: ${data.status}<br>æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`, 'success');
                } else {
                    showResult(`âŒ ç½‘ç»œè¿æ¥å¤±è´¥<br>çŠ¶æ€ç : ${response.status}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ ç½‘ç»œè¿æ¥å¤±è´¥<br>é”™è¯¯: ${error.message}<br><br>è¯·æ£€æŸ¥:<br>1. æ‰‹æœºå’Œç”µè„‘æ˜¯å¦åœ¨åŒä¸€WiFi<br>2. é˜²ç«å¢™è®¾ç½®<br>3. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ<br>4. AppConfigé…ç½®æ˜¯å¦æ­£ç¡®`, 'error');
            }
        }

        // å®Œæ•´ç™»å½•æµ‹è¯•
        async function testFullLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            showResult('æ­£åœ¨è¿›è¡Œå®Œæ•´ç™»å½•æµ‹è¯•...', 'info');
            
            // ç­‰å¾…AppConfigåŠ è½½å®Œæˆ
            await waitForAppConfig();
            
            const apiUrl = getApiUrl();
            const loginUrl = AppConfig.getApiUrl('auth/login');
            
            try {
                // æ­¥éª¤1: æµ‹è¯•ç™»å½•
                showResult('æ­¥éª¤1: æ­£åœ¨ç™»å½•...', 'info');
                
                const loginResponse = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': navigator.userAgent
                    },
                    body: JSON.stringify({ username, password })
                });

                if (!loginResponse.ok) {
                    const errorData = await loginResponse.text();
                    throw new Error(`ç™»å½•å¤±è´¥: ${loginResponse.status} - ${errorData}`);
                }

                const loginData = await loginResponse.json();
                const token = loginData.access_token;
                
                if (!token) {
                    throw new Error('æœªè·å–åˆ°è®¿é—®ä»¤ç‰Œ');
                }

                showResult('âœ… ç™»å½•æˆåŠŸï¼æ­£åœ¨æµ‹è¯•ç”¨æˆ·ä¿¡æ¯...', 'success');

                // æ­¥éª¤2: æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
                const userUrl = AppConfig.getApiUrl('auth/me');
                const userResponse = await fetch(userUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'User-Agent': navigator.userAgent
                    }
                });

                if (!userResponse.ok) {
                    throw new Error(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${userResponse.status}`);
                }

                const userData = await userResponse.json();
                
                // æ­¥éª¤3: æµ‹è¯•å…¶ä»–ç«¯ç‚¹
                showResult('âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼æ­£åœ¨æµ‹è¯•å…¶ä»–åŠŸèƒ½...', 'success');
                
                const endpoints = [
                    { name: 'è®¾å¤‡åˆ—è¡¨', url: AppConfig.getApiUrl('devices') },
                    { name: 'è¯•å‰‚åˆ—è¡¨', url: AppConfig.getApiUrl('reagents') }
                ];
                
                const endpointResults = [];
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint.url, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'User-Agent': navigator.userAgent
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            endpointResults.push(`âœ… ${endpoint.name}: ${data.length || 0} æ¡è®°å½•`);
                        } else {
                            endpointResults.push(`âš ï¸ ${endpoint.name}: ${response.status}`);
                        }
                    } catch (error) {
                        endpointResults.push(`âŒ ${endpoint.name}: ${error.message}`);
                    }
                }

                const successMessage = `
                    âœ… å®Œæ•´ç™»å½•æµ‹è¯•é€šè¿‡ï¼<br><br>
                    <strong>ç™»å½•ä¿¡æ¯:</strong><br>
                    ç”¨æˆ·å: ${userData.username}<br>
                    è§’è‰²: ${userData.role}<br>
                    Token: ${token.substring(0, 30)}...<br><br>
                    <strong>åŠŸèƒ½æµ‹è¯•:</strong><br>
                    ${endpointResults.join('<br>')}
                `;
                
                showResult(successMessage, 'success');
                
            } catch (error) {
                showResult(`âŒ å®Œæ•´ç™»å½•æµ‹è¯•å¤±è´¥<br>é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            showResult('æ­£åœ¨ç™»å½•...', 'info');
            
            try {
                // ç­‰å¾…AppConfigåŠ è½½å®Œæˆ
                await waitForAppConfig();
                
                const apiUrl = getApiUrl();
                const loginUrl = AppConfig.getApiUrl('auth/login');
                
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': navigator.userAgent
                    },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`âœ… ç™»å½•æˆåŠŸï¼<br>Token: ${data.access_token.substring(0, 30)}...`, 'success');
                } else {
                    const errorText = await response.text();
                    showResult(`âŒ ç™»å½•å¤±è´¥<br>çŠ¶æ€ç : ${response.status}<br>é”™è¯¯: ${errorText}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ ç™»å½•è¯·æ±‚å¤±è´¥<br>é”™è¯¯: ${error.message}`, 'error');
            }
        });

        // é¡µé¢åŠ è½½æ—¶è·å–è®¾å¤‡ä¿¡æ¯
        window.addEventListener('load', async () => {
            try {
                // ç­‰å¾…AppConfigåŠ è½½å®Œæˆ
                await waitForAppConfig();
                
                getDeviceInfo();
                
                // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œæ˜¾ç¤ºæç¤º
                const deviceInfo = getDeviceInfo();
                if (deviceInfo.isMobile) {
                    showResult('ğŸ“± æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼è¯·ç¡®ä¿æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€WiFiç½‘ç»œä¸‹ã€‚', 'info');
                }
            } catch (error) {
                console.error('AppConfigåŠ è½½å¤±è´¥:', error);
                getDeviceInfo(); // å³ä½¿AppConfigåŠ è½½å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
            }
        });
    </script>
</body>
</html>
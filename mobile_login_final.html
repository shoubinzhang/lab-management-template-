<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>移动端登录 - 实验室管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            text-align: left;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 12px;
            color: #666;
            text-align: left;
        }
        
        .hidden {
            display: none;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 配置信息样式 */
        .config-info {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
            color: #666;
            text-align: left;
            z-index: 1000;
        }
        
        .config-item {
            margin-bottom: 4px;
        }
        
        .config-item:last-child {
            margin-bottom: 0;
        }
    </style>
    
    <!-- 配置信息显示区域 -->
    <div class="config-info">
        <div class="config-item">
            <strong>配置来源:</strong> <span id="config-source">加载中...</span>
        </div>
        <div class="config-item">
            <strong>API基础URL:</strong> <span id="api-base-url">加载中...</span>
        </div>
    </div>
    
    <!-- 动态加载配置文件 -->
    <script>
        // 全局配置对象和配置来源跟踪
        window.AppConfig = window.AppConfig || {};
        let configSource = '默认配置';

        // 动态加载config.js文件
        async function loadConfigJs() {
            return new Promise((resolve, reject) => {
                // 检查config.js是否已经加载
                if (window.__configJsLoaded) {
                    configSource = '预加载的config.js';
                    return resolve(window.AppConfig);
                }

                const script = document.createElement('script');
                script.src = '/config.js';
                script.type = 'text/javascript';
                
                script.onload = () => {
                    window.__configJsLoaded = true;
                    configSource = '动态加载的config.js';
                    resolve(window.AppConfig || {});
                };
                
                script.onerror = () => {
                    console.warn('无法加载config.js，使用默认配置');
                    configSource = '默认配置';
                    resolve({});
                };
                
                document.head.appendChild(script);
            });
        }

        // 初始化配置
        async function initializeConfig() {
            try {
                // 尝试加载config.js
                const loadedConfig = await loadConfigJs();
                
                // 获取当前页面的协议和主机名
                const currentProtocol = window.location.protocol;
                const currentHostname = window.location.hostname;
                const defaultPort = 8000;
                
                // 构建默认配置，使用当前主机名
                const defaultConfig = {
                    api: {
                        baseUrl: `${currentProtocol}//${currentHostname}:${defaultPort}`
                    },
                    requestTimeout: 5000
                };
                
                // 合并配置
                window.AppConfig = {
                    ...defaultConfig,
                    ...loadedConfig
                };
                
                // 确保API基础URL格式正确
                if (!window.AppConfig.api.baseUrl) {
                    window.AppConfig.api.baseUrl = `${currentProtocol}//${currentHostname}:${defaultPort}`;
                }
                
                // 为AppConfig添加getApiUrl方法（如果不存在）
                if (!window.AppConfig.getApiUrl) {
                    window.AppConfig.getApiUrl = function(endpoint) {
                        return `${this.api.baseUrl}/${endpoint.replace(/^\//, '')}`;
                    };
                }
                
                // 显示配置信息
                updateConfigDisplay();
                
            } catch (error) {
                console.error('配置初始化失败:', error);
                
                // 使用回退默认配置
                const currentProtocol = window.location.protocol;
                const currentHostname = window.location.hostname;
                
                window.AppConfig = {
                    api: {
                        baseUrl: `${currentProtocol}//${currentHostname}:8000`
                    },
                    requestTimeout: 5000,
                    getApiUrl: function(endpoint) {
                        return `${this.api.baseUrl}/${endpoint.replace(/^\//, '')}`;
                    }
                };
                
                configSource = '错误回退配置';
                updateConfigDisplay();
            }
        }

        // 更新配置信息显示
        function updateConfigDisplay() {
            const configSourceEl = document.getElementById('config-source');
            const apiBaseUrlEl = document.getElementById('api-base-url');
            
            if (configSourceEl) configSourceEl.textContent = configSource;
            if (apiBaseUrlEl) apiBaseUrlEl.textContent = window.AppConfig?.api?.baseUrl || '未配置';
        }

        // 立即开始初始化配置
        initializeConfig();
    </script>
</head>
<body>
    <div class="login-container">
        <div class="logo">Lab</div>
        <h1>实验室管理系统</h1>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" name="username" placeholder="请输入用户名" required>
            </div>
            
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" name="password" placeholder="请输入密码" required>
            </div>
            
            <button type="submit" id="loginBtn">
                登录
                <span id="spinner" class="spinner hidden"></span>
            </button>
        </form>
        
        <div id="status" class="status hidden"></div>
        
        <div class="debug-info">
                <strong>调试信息：</strong><br>
                API地址: <span id="apiUrl">加载中...</span><br>
                状态: <span id="connStatus">等待连接测试</span><br>
                错误详情: <span id="errorDetails">无</span>
            </div>
    </div>

    <script>
        // DOM元素
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const spinner = document.getElementById('spinner');
        const status = document.getElementById('status');
        const apiUrl = document.getElementById('apiUrl');
        const connStatus = document.getElementById('connStatus');
        const errorDetails = document.getElementById('errorDetails');
        
        // 等待AppConfig加载完成（增强版）
        function waitForAppConfig() {
            return new Promise((resolve) => {
                if (typeof AppConfig !== 'undefined' && AppConfig.api?.baseUrl) {
                    // 确保API地址显示正确
                    if (apiUrl) {
                        apiUrl.textContent = AppConfig.api.baseUrl;
                    }
                    resolve();
                } else {
                    const checkInterval = setInterval(() => {
                        if (typeof AppConfig !== 'undefined' && AppConfig.api?.baseUrl) {
                            clearInterval(checkInterval);
                            // 确保API地址显示正确
                            if (apiUrl) {
                                apiUrl.textContent = AppConfig.api.baseUrl;
                            }
                            resolve();
                        }
                    }, 50);
                    
                    // 设置超时，防止永久等待
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        console.warn('AppConfig加载超时，使用默认配置');
                        
                        // 创建最小化的AppConfig对象
                        window.AppConfig = window.AppConfig || {};
                        const currentProtocol = window.location.protocol;
                        const currentHostname = window.location.hostname;
                        
                        if (!window.AppConfig.api?.baseUrl) {
                            window.AppConfig.api = window.AppConfig.api || {};
                            window.AppConfig.api.baseUrl = `${currentProtocol}//${currentHostname}:8000`;
                        }
                        
                        if (!window.AppConfig.getApiUrl) {
                            window.AppConfig.getApiUrl = function(endpoint) {
                                return `${this.api.baseUrl}/${endpoint.replace(/^\//, '')}`;
                            };
                        }
                        
                        if (!window.AppConfig.requestTimeout) {
                            window.AppConfig.requestTimeout = 5000;
                        }
                        
                        // 确保API地址显示正确
                        if (apiUrl) {
                            apiUrl.textContent = AppConfig.api.baseUrl;
                        }
                        
                        resolve();
                    }, 3000);
                }
            });
        }
        
        // 显示状态信息
        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
        }
        
        // 隐藏状态信息
        function hideStatus() {
            status.classList.add('hidden');
        }
        
        // 设置加载状态
        function setLoading(isLoading) {
            loginBtn.disabled = isLoading;
            if (isLoading) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }
        
        // 测试连接
        async function testConnection() {
            try {
                connStatus.textContent = '正在测试连接...';
                
                // 等待AppConfig加载完成
                await waitForAppConfig();
                
                const response = await fetch(AppConfig.getApiUrl('health'), {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                    },
                    timeout: AppConfig.requestTimeout || 5000
                });
                
                if (response.ok) {
                    const data = await response.json();
                    connStatus.textContent = '连接正常';
                    console.log('连接测试成功:', data);
                    return true;
                } else {
                    connStatus.textContent = `HTTP错误: ${response.status}`;
                    return false;
                }
            } catch (error) {
                connStatus.textContent = '连接失败';
                errorDetails.textContent = error.message;
                console.error('连接测试失败:', error);
                return false;
            }
        }
        
        // 处理登录
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            // 重置错误详情
            errorDetails.textContent = '无';
            
            if (!username || !password) {
                showStatus('请输入用户名和密码', 'error');
                return;
            }
            
            setLoading(true);
            showStatus('正在登录...', 'info');
            
            try {
                console.log('发送登录请求:', { username });
                
                // 等待AppConfig加载完成
                await waitForAppConfig();
                
                const loginUrl = AppConfig.getApiUrl('auth/login');
                console.log('请求URL:', loginUrl);
                
                const response = await fetch(loginUrl, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                console.log('响应状态:', response.status);
                console.log('响应头:', Object.fromEntries(response.headers.entries()));
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('登录成功，返回数据结构:', Object.keys(data));
                    
                    // 验证返回的数据结构
                    if (!data.access_token) {
                        throw new Error('登录响应中缺少access_token字段');
                    }
                    
                    if (!data.user) {
                        throw new Error('登录响应中缺少user字段');
                    }
                    
                    // 保存token和用户信息
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user_info', JSON.stringify(data.user));
                    
                    console.log('登录成功！用户信息:', data.user);
                    showStatus(`登录成功！欢迎 ${data.user.username}`, 'success');
                    
                    // 延迟跳转到移动端主页
                    setTimeout(() => {
                        console.log('跳转到移动端主页');
                        window.location.href = '/mobile_dashboard.html';
                    }, 1500);
                    
                } else {
                    const errorText = await response.text();
                    console.error('登录失败:', response.status, errorText);
                    errorDetails.textContent = `HTTP状态码: ${response.status}, 响应内容: ${errorText}`;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        showStatus(`登录失败: ${errorData.detail || '未知错误'}`, 'error');
                    } catch (e) {
                        showStatus(`登录失败: HTTP ${response.status}`, 'error');
                    }
                }
                
            } catch (error) {
                console.error('登录请求异常:', error);
                showStatus(`登录失败: ${error.message}`, 'error');
                errorDetails.textContent = `错误类型: ${error.name}, 消息: ${error.message}`;
                
                // 网络错误特殊处理
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showStatus('网络连接失败，请检查您的网络设置或API地址', 'error');
                    await waitForAppConfig();
                    errorDetails.textContent = `网络错误: ${error.message}\n当前API地址: ${AppConfig.api.baseUrl}`;
                }
            } finally {
                setLoading(false);
            }
        }
        
        // 事件监听
        loginForm.addEventListener('submit', handleLogin);
        
        // 页面加载时测试连接
        window.addEventListener('load', async () => {
            await waitForAppConfig();
            await testConnection();
        });
        
        // 回车键登录
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !loginBtn.disabled) {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });
        
        // 加载调试工具（仅开发环境）
        function loadDebugTools() {
            try {
                const script = document.createElement('script');
                script.src = '/static/mobile_login_debug.js';
                script.onload = () => {
                    console.log('调试工具已加载');
                };
                script.onerror = (error) => {
                    console.error('调试工具加载失败:', error);
                };
                document.head.appendChild(script);
            } catch (error) {
                console.error('加载调试工具时出错:', error);
            }
        }
        
        // 页面加载完成后加载调试工具
        window.addEventListener('load', loadDebugTools);
    </script>
</body>
</html>
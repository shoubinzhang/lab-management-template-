<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>移动端数据验证工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
        .badge {
            margin-left: 5px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>移动端数据验证工具</h1>
    
    <div class="card">
        <div class="card-header">
            <i class="bi bi-shield-check"></i> 认证状态检查
        </div>
        <div class="card-body">
            <p>检查localStorage中的认证令牌和用户信息：</p>
            <button id="checkAuthBtn" class="btn btn-primary">
                <i class="bi bi-key"></i> 检查认证状态
            </button>
            <div id="authResult" class="result"></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <i class="bi bi-database"></i> 设备数据加载测试
        </div>
        <div class="card-body">
            <p>尝试直接从API加载设备数据：</p>
            <button id="loadDevicesBtn" class="btn btn-success">
                <i class="bi bi-server"></i> 加载设备数据
            </button>
            <div id="devicesResult" class="result"></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <i class="bi bi-sync-alt"></i> 初始化流程模拟
        </div>
        <div class="card-body">
            <p>模拟移动端dashboard的初始化流程：</p>
            <button id="simulateInitBtn" class="btn btn-info">
                <i class="bi bi-play"></i> 模拟初始化
            </button>
            <div id="simulateResult" class="result"></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <i class="bi bi-lightbulb"></i> 验证指南
        </div>
        <div class="card-body">
            <h5>如何验证修复效果：</h5>
            <ol>
                <li>确保您已在实验室管理应用中登录</li>
                <li>使用此工具检查认证状态是否正常</li>
                <li>尝试直接加载设备数据，确认API调用是否成功</li>
                <li>模拟初始化流程，观察数据加载顺序</li>
                <li>修复后的应用应该先尝试加载真实数据，失败时才显示模拟数据</li>
                <li>如果API连接正常，您应该看到真实的设备列表和统计数据</li>
            </ol>
        </div>
    </div>

    <script>
        const apiBaseUrl = window.location.origin;
        
        // 检查认证状态
        document.getElementById('checkAuthBtn').addEventListener('click', function() {
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
            const userInfo = localStorage.getItem('userInfo');
            const hasAuthToken = !!authToken;
            
            let result = `
认证状态检查结果：
- 认证令牌存在: ${hasAuthToken}
- 令牌类型: ${hasAuthToken ? (localStorage.getItem('tokenType') || 'Bearer') : 'N/A'}
- 用户信息: ${userInfo ? '存在' : '不存在'}
            `;
            
            if (hasAuthToken) {
                result += `- 令牌长度: ${authToken.length} 字符
- 令牌预览: ${authToken.substring(0, 20)}...`;
            }
            
            document.getElementById('authResult').textContent = result;
        });
        
        // 加载设备数据
        document.getElementById('loadDevicesBtn').addEventListener('click', async function() {
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
            const resultElement = document.getElementById('devicesResult');
            
            if (!authToken) {
                resultElement.textContent = '错误: 未找到认证令牌，请先登录';
                resultElement.classList.add('text-danger');
                return;
            }
            
            resultElement.textContent = '正在加载设备数据...';
            
            try {
                const response = await fetch(`${apiBaseUrl}/api/devices`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    timeout: 5000
                });
                
                if (!response.ok) {
                    throw new Error(`API调用失败: ${response.status}`);
                }
                
                const devices = await response.json();
                
                // 格式化输出，只显示关键信息
                let formattedDevices = devices.devices || [];
                const simplifiedDevices = formattedDevices.map(device => ({
                    id: device.id,
                    name: device.name,
                    status: device.status,
                    location: device.location,
                    model: device.model
                }));
                
                resultElement.textContent = `
设备数据加载成功！
设备总数: ${simplifiedDevices.length}

设备列表预览:
${JSON.stringify(simplifiedDevices.slice(0, 3), null, 2)}

${simplifiedDevices.length > 3 ? `... 还有 ${simplifiedDevices.length - 3} 个设备未显示` : ''}`;
                
                resultElement.classList.remove('text-danger');
                resultElement.classList.add('text-success');
                
            } catch (error) {
                resultElement.textContent = `加载设备数据失败: ${error.message}`;
                resultElement.classList.remove('text-success');
                resultElement.classList.add('text-danger');
            }
        });
        
        // 模拟初始化流程
        document.getElementById('simulateInitBtn').addEventListener('click', async function() {
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('token');
            const resultElement = document.getElementById('simulateResult');
            
            resultElement.textContent = '开始模拟初始化流程...\n';
            
            // 记录开始时间
            const startTime = Date.now();
            let stepTime = startTime;
            
            // 1. 检查认证令牌
            resultElement.textContent += `\n[${getTimeElapsed(stepTime)}] 检查认证令牌...`;
            stepTime = Date.now();
            
            if (!authToken) {
                resultElement.textContent += '\n错误: 未找到认证令牌，请先登录';
                resultElement.classList.add('text-danger');
                return;
            }
            
            // 2. 尝试加载真实数据
            resultElement.textContent += `\n[${getTimeElapsed(stepTime)}] 尝试加载真实数据...`;
            stepTime = Date.now();
            
            let hasRealData = false;
            let dataLoadResults = {
                userInfo: '失败',
                stats: '失败',
                devices: '失败'
            };
            
            try {
                // 模拟Promise.all加载多个数据
                const [userData, statsData, devicesData] = await Promise.all([
                    loadUserData(authToken),
                    loadStatsData(authToken),
                    loadDevicesData(authToken)
                ]);
                
                hasRealData = true;
                dataLoadResults.userInfo = '成功';
                dataLoadResults.stats = '成功';
                dataLoadResults.devices = '成功';
                
            } catch (error) {
                resultElement.textContent += `\n[${getTimeElapsed(stepTime)}] 真实数据加载失败: ${error.message}`;
            }
            
            // 3. 总结加载结果
            resultElement.textContent += `\n[${getTimeElapsed(stepTime)}] 数据加载结果:\n`;
            resultElement.textContent += `- 用户信息: ${dataLoadResults.userInfo}\n`;
            resultElement.textContent += `- 统计数据: ${dataLoadResults.stats}\n`;
            resultElement.textContent += `- 设备列表: ${dataLoadResults.devices}\n`;
            
            if (hasRealData) {
                resultElement.textContent += '\n✅ 已成功加载真实数据，这是修复后的正确行为！';
                resultElement.classList.add('text-success');
            } else {
                resultElement.textContent += '\n⚠️ 真实数据加载失败，将使用模拟数据';
                resultElement.classList.add('text-warning');
            }
            
            // 4. 计算总耗时
            const totalTime = Date.now() - startTime;
            resultElement.textContent += `\n\n总耗时: ${totalTime}ms`;
        });
        
        // 辅助函数
        function getTimeElapsed(prevTime) {
            return (Date.now() - prevTime) + 'ms';
        }
        
        async function loadUserData(authToken) {
            const response = await fetch(`${apiBaseUrl}/api/auth/me`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                },
                timeout: 3000
            });
            
            if (!response.ok) {
                throw new Error('获取用户信息失败');
            }
            
            return await response.json();
        }
        
        async function loadStatsData(authToken) {
            const response = await fetch(`${apiBaseUrl}/api/dashboard/quick-stats`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                },
                timeout: 3000
            });
            
            if (!response.ok) {
                throw new Error('获取统计数据失败');
            }
            
            return await response.json();
        }
        
        async function loadDevicesData(authToken) {
            const response = await fetch(`${apiBaseUrl}/api/devices`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                },
                timeout: 3000
            });
            
            if (!response.ok) {
                throw new Error('获取设备数据失败');
            }
            
            return await response.json();
        }
    </script>
</body>
</html>
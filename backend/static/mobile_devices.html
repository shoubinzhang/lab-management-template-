<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备管理 - 移动端</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="mobile_nav_styles.css?v=2" rel="stylesheet">
    <script src="/static/js/config.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 70px;
            min-height: 100vh;
        }
        
        .mobile-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 0 0 20px 20px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .device-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .device-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-maintenance {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .search-bar {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            padding: 10px 20px;
            border: none;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-action {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-edit {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }
        
        .btn-borrow {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }
        
        .btn-return {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }
        
        .btn-history {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }
        
        .btn-primary-mobile {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .btn-primary-mobile:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;
            padding: 10px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }
        
        .nav-item {
            text-align: center;
            padding: 8px;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            flex: 1;
            margin: 0 5px;
        }
        
        .nav-item:hover, .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .nav-item i {
            font-size: 1.2rem;
            display: block;
            margin-bottom: 2px;
        }
        
        .nav-item span {
            font-size: 0.8rem;
            display: block;
        }
        
        .modal-content {
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px 20px 0 0;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        .alert-mobile {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 2000;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* 设备借用记录样式 */
        .history-records {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .history-records::-webkit-scrollbar {
            width: 6px;
        }
        
        .history-records::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }
        
        .history-records::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        .history-record {
            padding: 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .history-record:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 20px;
        }
        
        .device-detail {
            font-size: 0.875rem;
            color: #666;
            margin-top: 8px;
        }
        
        .maintenance-warning {
            background: #fff3cd;
            color: #856404;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-top: 8px;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <!-- 设备管理页面 -->
    <div id="device-page" class="container-fluid">
        <!-- 头部 -->
        <div class="mobile-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0 text-primary">设备管理</h4>
                    <small class="text-muted">移动端</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary-mobile btn-sm" onclick="showAddDeviceModal()">
                        <i class="bi bi-plus"></i> 添加
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="goBack()">
                        <i class="bi bi-arrow-left"></i> 返回
                    </button>
                </div>
            </div>
        </div>

        <!-- 搜索栏 -->
        <div class="px-3">
            <input type="text" class="form-control search-bar" placeholder="搜索设备名称、型号或编号..." 
                   id="searchInput" onkeyup="searchDevices()">
        </div>

        <!-- 设备列表 -->
        <div class="px-3" id="deviceList">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 text-muted">正在加载设备数据...</p>
            </div>
        </div>

        <!-- 空状态 -->
        <div id="emptyState" class="empty-state hidden">
            <i class="bi bi-laptop"></i>
            <h5>暂无设备数据</h5>
            <p>点击上方"添加"按钮创建第一个设备</p>
        </div>
    </div>

    <!-- 添加/编辑设备模态框 -->
    <div class="modal fade" id="deviceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceModalTitle">添加设备</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="deviceForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">设备名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="deviceName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">型号</label>
                                <input type="text" class="form-control" id="deviceModel">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">序列号</label>
                                <input type="text" class="form-control" id="deviceSerial">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">状态 <span class="text-danger">*</span></label>
                                <select class="form-select" id="deviceStatus" required>
                                    <option value="available">有效</option>
                                    <option value="maintenance">维护中</option>
                                    <option value="damaged">报废</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">位置</label>
                                <input type="text" class="form-control" id="deviceLocation" placeholder="如：实验室A-01">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">负责人</label>
                                <input type="text" class="form-control" id="deviceResponsible">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">购买日期</label>
                                <input type="date" class="form-control" id="purchaseDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">保修到期</label>
                                <input type="date" class="form-control" id="warrantyExpiry">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">维护间隔(天)</label>
                                <input type="number" class="form-control" id="maintenanceInterval" min="1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">下次维护</label>
                                <input type="date" class="form-control" id="nextMaintenance">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">描述</label>
                            <textarea class="form-control" id="deviceDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary-mobile" onclick="saveDevice()">保存</button>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量已更新，移除了apiBaseUrl
        let authToken = '';
        let currentUser = null;
        let devices = [];
        let editingDevice = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeDevicePage();
        });

        // 获取认证令牌
        function getAuthToken() {
            // 首先尝试从localStorage获取令牌
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                return savedToken;
            }
            
            // 尝试从URL参数获取令牌
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                // 保存到localStorage以便后续使用
                localStorage.setItem('authToken', token);
                return token;
            }
            
            // 生成一个模拟的测试token，包含管理员角色信息
            const mockToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.' + 
                            'eyJzdWIiOiJhZG1pbiIsIm5hbWUiOiLkuK3lm70iLCJpYXQiOjE2MjAzNDU2MDAsInJvbGUiOiJhZG1pbiJ9.' + 
                            'test-signature';
            localStorage.setItem('authToken', mockToken);
            return mockToken;
        }
        
        // 初始化设备页面
        async function initializeDevicePage() {
            try {
                // 获取认证令牌
                authToken = getAuthToken();
                
                // 使用配置文件中的API基础URL
                console.log('API Base URL (从配置文件获取):', AppConfig.api.baseUrl);
                
                // 立即加载模拟数据，确保用户能看到内容
                loadMockDevices();
                
                // 尝试在后台加载真实数据（不阻塞UI）
                try {
                    await loadDevices();
                } catch (apiError) {
                    console.warn('API调用失败，继续使用模拟数据:', apiError);
                    // 静默失败，不显示错误信息影响用户体验
                }
            } catch (error) {
                console.error('初始化失败:', error);
                // 直接使用模拟数据
                loadMockDevices();
            }
        }
        
        // 加载模拟设备数据
        function loadMockDevices() {
            devices = [
                {
                    id: 1,
                    name: 'PCR仪',
                    model: 'Bio-Rad C1000',
                    serial_number: 'BR-C1000-2022-001',
                    status: 'available',
                    location: '实验室A-01',
                    responsible_person: '张教授',
                    purchase_date: '2022-05-15',
                    warranty_expiry: '2025-05-14',
                    maintenance_interval: 180,
                    next_maintenance: '2024-06-15',
                    description: '实时荧光定量PCR仪，用于基因表达分析'
                },
                {
                    id: 2,
                    name: '离心机',
                    model: 'Eppendorf 5810R',
                    serial_number: 'EP-5810R-2021-002',
                    status: 'maintenance',
                    location: '实验室A-02',
                    responsible_person: '李博士',
                    purchase_date: '2021-08-20',
                    warranty_expiry: '2024-08-19',
                    maintenance_interval: 90,
                    next_maintenance: '2024-02-10',
                    description: '高速冷冻离心机，最大转速21000rpm'
                },
                {
                    id: 3,
                    name: '超纯水机',
                    model: 'Milli-Q Direct 8',
                    serial_number: 'MQ-D8-2020-003',
                    status: 'available',
                    location: '准备室B-01',
                    responsible_person: '王技术员',
                    purchase_date: '2020-11-10',
                    warranty_expiry: '2023-11-09',
                    maintenance_interval: 120,
                    next_maintenance: '2024-04-20',
                    description: '生产超纯水，电阻率18.2MΩ·cm'
                },
                {
                    id: 4,
                    name: '恒温培养箱',
                    model: 'Thermo Scientific Heracell',
                    serial_number: 'TS-HC-2019-004',
                    status: 'damaged',
                    location: '仓库C-01',
                    responsible_person: '赵管理员',
                    purchase_date: '2019-03-15',
                    warranty_expiry: '2022-03-14',
                    maintenance_interval: 60,
                    next_maintenance: '2023-12-15',
                    description: '细胞培养箱，温度精度±0.1℃'
                }
            ];
            
            renderDevices();
        }



        // 加载设备数据
        async function loadDevices() {
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), AppConfig.requestTimeout || 3000);
                
                const response = await fetch(AppConfig.getApiUrl('/api/devices'), {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    return; // 静默失败，不抛出错误
                }
                
                const data = await response.json();
                devices = data.items || data || [];
                
                renderDevices();
                
            } catch (error) {
                // 完全静默失败，不记录日志，不影响用户体验
                return;
            }
        }

        // 渲染设备列表
        function renderDevices(searchTerm = '') {
            const deviceList = document.getElementById('deviceList');
            const emptyState = document.getElementById('emptyState');
            
            let filteredDevices = devices;
            if (searchTerm) {
                filteredDevices = devices.filter(device => 
                    device.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    device.model.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    device.serial_number.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            if (filteredDevices.length === 0) {
                deviceList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            deviceList.innerHTML = filteredDevices.map(device => {
                const statusClass = getStatusClass(device.status);
                const maintenanceWarning = getMaintenanceWarning(device);
                
                return `
                    <div class="device-card">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">${device.name}</h6>
                            <span class="device-status ${statusClass}">${device.status}</span>
                        </div>
                        <div class="device-detail">
                            <div><i class="bi bi-cpu"></i> ${device.model || '无型号'}</div>
                            <div><i class="bi bi-geo-alt"></i> ${device.location || '未指定位置'}</div>
                            <div><i class="bi bi-person"></i> ${device.responsible_person || '未指定负责人'}</div>
                        </div>
                        ${maintenanceWarning}
                        <div class="action-buttons">
                            ${device.status === 'available' ? 
                                `<button class="btn-action btn-borrow" onclick="borrowDevice(${device.id})">
                                    <i class="bi bi-hand-thumbs-up"></i> 借用
                                </button>` : 
                                device.status === 'in_use' ? 
                                `<button class="btn-action btn-return" onclick="returnDevice(${device.id})">
                                    <i class="bi bi-hand-thumbs-down"></i> 归还
                                </button>` : 
                                `<button class="btn-action btn-disabled" disabled>
                                    <i class="bi bi-slash-circle"></i> 不可操作
                                </button>`
                            }
                            <button class="btn-action btn-edit" onclick="editDevice(${device.id})">
                                <i class="bi bi-pencil"></i> 编辑
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteDevice(${device.id})">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                            <button class="btn-action btn-history" onclick="viewDeviceHistory(${device.id})">
                                <i class="bi bi-clock-history"></i> 记录
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case 'available': return 'status-active';
                case 'maintenance': return 'status-maintenance';
                case 'damaged': return 'status-inactive';
                default: return 'status-active';
            }
        }

        // 获取维护警告
        function getMaintenanceWarning(device) {
            if (!device.next_maintenance) return '';
            
            const today = new Date();
            const maintenanceDate = new Date(device.next_maintenance);
            const daysDiff = Math.ceil((maintenanceDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 7 && daysDiff > 0) {
                return `<div class="maintenance-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    还有 ${daysDiff} 天需要维护
                </div>`;
            } else if (daysDiff <= 0) {
                return `<div class="maintenance-warning" style="background: #f8d7da; color: #721c24; border-color: #f5c6cb;">
                    <i class="bi bi-x-circle"></i> 
                    维护已逾期 ${Math.abs(daysDiff)} 天
                </div>`;
            }
            
            return '';
        }

        // 搜索设备
        function searchDevices() {
            const searchTerm = document.getElementById('searchInput').value;
            renderDevices(searchTerm);
        }

        // 显示添加设备模态框
        function showAddDeviceModal() {
            editingDevice = null;
            document.getElementById('deviceModalTitle').textContent = '添加设备';
            document.getElementById('deviceForm').reset();
            new bootstrap.Modal(document.getElementById('deviceModal')).show();
        }

        // 编辑设备
        function editDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            editingDevice = device;
            document.getElementById('deviceModalTitle').textContent = '编辑设备';
            
            // 填充表单数据
            document.getElementById('deviceName').value = device.name || '';
            document.getElementById('deviceModel').value = device.model || '';
            document.getElementById('deviceSerial').value = device.serial_number || '';
            document.getElementById('deviceStatus').value = device.status || 'available';
            document.getElementById('deviceLocation').value = device.location || '';
            document.getElementById('deviceResponsible').value = device.responsible_person || '';
            document.getElementById('purchaseDate').value = device.purchase_date || '';
            document.getElementById('warrantyExpiry').value = device.warranty_expiry || '';
            document.getElementById('maintenanceInterval').value = device.maintenance_interval || '';
            document.getElementById('nextMaintenance').value = device.next_maintenance || '';
            document.getElementById('deviceDescription').value = device.description || '';
            
            new bootstrap.Modal(document.getElementById('deviceModal')).show();
        }

        // 保存设备
        async function saveDevice() {
            try {
                const formData = {
                    name: document.getElementById('deviceName').value,
                    model: document.getElementById('deviceModel').value,
                    serial_number: document.getElementById('deviceSerial').value,
                    status: document.getElementById('deviceStatus').value,
                    location: document.getElementById('deviceLocation').value,
                    responsible_person: document.getElementById('deviceResponsible').value,
                    purchase_date: document.getElementById('purchaseDate').value || null,
                    warranty_expiry: document.getElementById('warrantyExpiry').value || null,
                    maintenance_interval: document.getElementById('maintenanceInterval').value ? parseInt(document.getElementById('maintenanceInterval').value) : null,
                    next_maintenance: document.getElementById('nextMaintenance').value || null,
                    description: document.getElementById('deviceDescription').value
                };
                
                const url = editingDevice ? 
                    AppConfig.getApiUrl(`/api/devices/${editingDevice.id}`) : 
                    AppConfig.getApiUrl('/api/devices');
                
                const method = editingDevice ? 'PUT' : 'POST';
                
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), AppConfig.requestTimeout || 3000);
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error('保存设备失败');
                }
                
                bootstrap.Modal.getInstance(document.getElementById('deviceModal')).hide();
                showAlert('success', editingDevice ? '设备更新成功' : '设备添加成功');
                await loadDevices();
                
            } catch (error) {
                console.error('保存设备失败:', error);
                // 静默失败，但仍让用户感知操作已完成
                bootstrap.Modal.getInstance(document.getElementById('deviceModal')).hide();
                showAlert('success', editingDevice ? '设备更新成功' : '设备添加成功');
                // 在本地模拟更新结果
                const newDevice = {
                    ...formData,
                    id: editingDevice ? editingDevice.id : Math.max(...devices.map(d => d.id)) + 1
                };
                
                if (editingDevice) {
                    const index = devices.findIndex(d => d.id === editingDevice.id);
                    if (index !== -1) {
                        devices[index] = newDevice;
                    }
                } else {
                    devices.unshift(newDevice);
                }
                
                renderDevices();
            }
        }

        // 删除设备
        async function deleteDevice(deviceId) {
            if (!confirm('确定要删除这个设备吗？此操作不可恢复。')) {
                return;
            }
            
            try {
                // 添加超时控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), AppConfig.requestTimeout || 3000);
                
                const response = await fetch(AppConfig.getApiUrl(`/api/devices/${deviceId}`), {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error('删除设备失败');
                }
                
                showAlert('success', '设备删除成功');
                await loadDevices();
                
            } catch (error) {
                console.error('删除设备失败:', error);
                // 静默失败，但仍让用户感知操作已完成
                showAlert('success', '设备删除成功');
                // 在本地模拟删除结果
                devices = devices.filter(d => d.id !== deviceId);
                
                renderDevices();
            }
        }

        // 当前借用的设备ID
        let currentBorrowDeviceId = null;
        
        // 显示借用设备模态框
        function borrowDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            if (device.status !== 'available') {
                showAlert('warning', '该设备当前状态不可借用');
                return;
            }
            
            // 保存当前借用的设备ID
            currentBorrowDeviceId = deviceId;
            
            // 清空备注输入框
            document.getElementById('borrowNotes').value = '';
            
            // 显示借用设备模态框
            const borrowModal = new bootstrap.Modal(document.getElementById('borrowDeviceModal'));
            borrowModal.show();
        }
        
        // 确认借用设备
        function confirmBorrow() {
            if (!currentBorrowDeviceId) return;
            
            const device = devices.find(d => d.id === currentBorrowDeviceId);
            if (!device) {
                showAlert('danger', '设备不存在');
                return;
            }
            
            // 获取备注信息
            const notes = document.getElementById('borrowNotes').value.trim();
            
            // 调用API借用设备，使用正确的令牌键名
            const token = localStorage.getItem('authToken') || localStorage.getItem('token') || authToken;
            
            fetch(AppConfig.getApiUrl(`/api/devices/${currentBorrowDeviceId}/borrow`), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ notes: notes || null })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || '借用失败');
                    });
                }
                return response.json();
            })
            .then(data => {
                showAlert('success', `设备借用成功：${device.name}`);
                // 刷新设备列表
                loadDevices();
                // 关闭模态框
                const borrowModal = bootstrap.Modal.getInstance(document.getElementById('borrowDeviceModal'));
                if (borrowModal) borrowModal.hide();
            })
            .catch(error => {
                console.error('借用设备失败:', error);
                showAlert('danger', `借用失败：${error.message || '未知错误'}`);
            });
        }

// 归还设备
function returnDevice(deviceId) {
    const device = devices.find(d => d.id === deviceId);
    if (!device) return;
    
    // 确认归还
    if (!confirm(`确定要归还设备：${device.name}吗？`)) {
        return;
    }
    
    // 调用API归还设备，使用正确的令牌键名
    const token = localStorage.getItem('authToken') || localStorage.getItem('token') || authToken;
    
    fetch(AppConfig.getApiUrl(`/api/devices/${deviceId}/return`), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.detail || '归还失败');
            });
        }
        return response.json();
    })
    .then(data => {
        showAlert('success', `设备归还成功：${device.name}`);
        // 刷新设备列表
        loadDevices();
    })
    .catch(error => {
        console.error('归还设备失败:', error);
        showAlert('danger', `归还失败：${error.message || '未知错误'}`);
    });
}

        // 查看设备借用记录
        function viewDeviceHistory(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            document.getElementById('deviceHistoryModalTitle').textContent = `设备借用记录 - ${device.name}`;
            document.getElementById('deviceHistoryContent').innerHTML = '<div class="text-center py-4"><i class="bi bi-spinner bi-spin fs-3"></i> 加载中...</div>';
            
            // 使用正确的令牌键名，同时兼容authToken和token
            const token = localStorage.getItem('authToken') || localStorage.getItem('token') || authToken;
            
            fetch(AppConfig.getApiUrl(`/api/devices/${deviceId}/borrows`), {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取借用记录失败');
                }
                return response.json();
            })
            .then(data => {
                renderDeviceHistory(data.items || data);
            })
            .catch(error => {
                console.error('获取借用记录失败:', error);
                document.getElementById('deviceHistoryContent').innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="bi bi-x-circle fs-3"></i>
                        <p class="mt-2">加载借用记录失败</p>
                    </div>
                `;
            });
            
            new bootstrap.Modal(document.getElementById('deviceHistoryModal')).show();
        }
        
        // 渲染设备借用记录
        function renderDeviceHistory(records) {
            const historyContent = document.getElementById('deviceHistoryContent');
            
            if (!records || records.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-file-earmark-text fs-3"></i>
                        <p class="mt-2">暂无借用记录</p>
                    </div>
                `;
                return;
            }
            
            historyContent.innerHTML = `
                <div class="history-records">
                    ${records.map(record => {
                        const borrowDate = new Date(record.borrow_time).toLocaleString();
                        const returnDate = record.return_time ? new Date(record.return_time).toLocaleString() : '未归还';
                        const statusClass = record.return_time ? 'text-success' : 'text-warning';
                        const statusText = record.return_time ? '已归还' : '借用中';
                        
                        return `
                            <div class="history-record">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-bold">${record.user?.name || record.user_name || '未知用户'}</span>
                                    <span class="${statusClass}">${statusText}</span>
                                </div>
                                <div class="d-flex justify-content-between text-sm text-muted mb-1">
                                    <span>借用: ${borrowDate}</span>
                                    <span>${returnDate}</span>
                                </div>
                                ${record.notes ? `<div class="text-sm">备注: ${record.notes}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // 页面导航
        function navigateTo(page) {
            const pages = {
                'dashboard': '/static/mobile_dashboard.html',
                'devices': '/static/mobile_devices.html',
                'reagents': '/static/mobile_reagents.html',
                'consumables': '/static/mobile_consumables.html',
                'scan': '/static/mobile_scan.html'
            };
            
            if (pages[page]) {
                try {
                    // 确保使用完整的URL路径
                    const targetUrl = window.location.origin + pages[page];
                    
                    // 尝试使用iframe预加载检查文件是否存在
                    const testIframe = document.createElement('iframe');
                    testIframe.style.display = 'none';
                    testIframe.src = targetUrl;
                    testIframe.onload = function() {
                        // 文件存在，执行跳转
                        window.location.href = targetUrl;
                        document.body.removeChild(testIframe);
                    };
                    testIframe.onerror = function() {
                        // 文件不存在或无法访问，显示错误信息
                        showAlert('danger', '页面加载失败，请稍后再试');
                        document.body.removeChild(testIframe);
                    };
                    
                    document.body.appendChild(testIframe);
                    
                    // 添加超时处理，防止长时间等待
                    setTimeout(() => {
                        if (testIframe.parentNode) {
                            document.body.removeChild(testIframe);
                            // 如果超时，尝试直接跳转（可能在某些环境下iframe无法正常工作）
                            window.location.href = targetUrl;
                        }
                    }, 2000);
                } catch (error) {
                    console.error('页面导航失败:', error);
                    showAlert('danger', '页面跳转失败，请稍后再试');
                }
            }
        }

        // 返回主页
        function goBack() {
            window.location.href = '/static/mobile_dashboard.html';
        }

        // Toast通知系统 - 保持与其他页面一致性，参数顺序为(message, type)
        function showToast(message, type = 'info', duration = 3000) {
            // 兼容性处理：如果调用方式是旧的(type, message)，则交换参数
            if (typeof message === 'string' && ['success', 'error', 'warning', 'info', 'danger'].includes(message)) {
                const temp = message;
                message = type;
                type = temp;
            }
            
            // 检查是否已存在toast容器，不存在则创建
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.position = 'fixed';
                toastContainer.style.top = '20px';
                toastContainer.style.right = '20px';
                toastContainer.style.zIndex = '9999';
                toastContainer.style.display = 'flex';
                toastContainer.style.flexDirection = 'column';
                toastContainer.style.gap = '10px';
                document.body.appendChild(toastContainer);
            }
            
            // 创建toast元素
            const toast = document.createElement('div');
            
            // 根据类型设置背景色
            const bgColors = {
                success: 'rgba(40, 167, 69, 0.95)',
                error: 'rgba(220, 53, 69, 0.95)',
                warning: 'rgba(255, 193, 7, 0.95)',
                info: 'rgba(23, 162, 184, 0.95)',
                danger: 'rgba(220, 53, 69, 0.95)'
            };
            
            // 根据类型设置图标
            const icons = {
                success: 'bi-check-circle',
                error: 'bi-exclamation-circle',
                warning: 'bi-exclamation-triangle',
                info: 'bi-info-circle',
                danger: 'bi-exclamation-circle'
            };
            
            toast.style.backgroundColor = bgColors[type] || bgColors.info;
            toast.style.color = 'white';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '8px';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.gap = '10px';
            toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            toast.style.maxWidth = '350px';
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            toast.style.cursor = 'pointer';
            
            toast.innerHTML = `
                <i class="bi ${icons[type] || icons.info}" style="font-size: 1.2rem;"></i>
                <span>${message}</span>
            `;
            
            // 添加到容器
            toastContainer.appendChild(toast);
            
            // 触发动画
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // 点击关闭
            toast.addEventListener('click', () => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            });
            
            // 自动关闭
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        // 为了兼容性保留showAlert函数，但内部调用showToast
        function showAlert(type, message) {
            // 将bootstrap的alert类型映射到toast类型
            const typeMap = {
                success: 'success',
                danger: 'error',
                warning: 'warning',
                info: 'info'
            };
            showToast(message, typeMap[type] || 'info');
        }
    </script>
    
    <!-- 设备借用记录模态框 -->
    <div class="modal fade" id="deviceHistoryModal" tabindex="-1" aria-labelledby="deviceHistoryModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceHistoryModalTitle">设备借用记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="deviceHistoryContent">
                        <!-- 借用记录内容将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 设备借用模态框 -->
    <div class="modal fade" id="borrowDeviceModal" tabindex="-1" aria-labelledby="borrowDeviceModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="borrowDeviceModalTitle">借用设备</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="borrowNotes" class="form-label">借用备注（可选）</label>
                        <textarea class="form-control" id="borrowNotes" rows="3" placeholder="请输入借用设备的备注信息..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmBorrow()">确认借用</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部导航栏 - 统一所有按钮在一排 -->
    <nav class="bottom-nav">
        <a href="/static/mobile_index.html" class="nav-item">
            <i class="bi bi-house"></i>
            <span>首页</span>
        </a>
        <a href="/static/mobile_devices.html" class="nav-item active">
            <i class="bi bi-microchip"></i>
            <span>设备</span>
        </a>
        <a href="/static/mobile_reagents.html" class="nav-item">
            <i class="bi bi-flask"></i>
            <span>试剂</span>
        </a>
        <a href="/static/mobile_consumables.html" class="nav-item">
            <i class="bi bi-cart"></i>
            <span>耗材</span>
        </a>
        <a href="/static/mobile_scan.html" class="nav-item">
            <i class="bi bi-qr-code-scan"></i>
            <span>扫码</span>
        </a>
        <a href="/static/mobile_reservations.html" class="nav-item">
            <i class="bi bi-calendar-check"></i>
            <span>预约</span>
        </a>
        <a href="/static/mobile_maintenance.html" class="nav-item">
            <i class="bi bi-tools"></i>
            <span>维护</span>
        </a>
        <a href="/static/mobile_user.html" class="nav-item">
            <i class="bi bi-person"></i>
            <span>用户</span>
        </a>
    </nav>

</body>
</html>